<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DH-PE v28.0 (Social)</title>
    
    <link rel="icon" type="image/jpg" href="logo-fp.jpg">
    <link rel="apple-touch-icon" href="logo-fp.jpg">
    <meta name="theme-color" content="#0038a8">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --pe-blue: #0038a8; --pe-yellow: #ffe500; --pe-red: #d50000; --pe-green: #009b3a;
            --bg-body: #f0f2f5; 
            --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        .uppercase-input { text-transform: uppercase; }
        
        body { background: var(--bg-body); min-height: 100vh; padding-bottom: 0; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 600px; margin: 0 auto; position: relative; min-height: 100vh; background: white; }

        /* GERAL */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 6px; background: var(--pe-blue); color: white; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); font-size: 14px; text-transform: uppercase; }
        .btn:active { transform: scale(0.97); background: #002a80; }
        .input-group { margin-bottom: 15px; width: 100%; }
        .input-group label { font-size: 11px; font-weight: 800; color: var(--pe-blue); margin-left: 2px; display: block; margin-bottom: 5px; }
        .input-wrapper { display: flex; align-items: center; position: relative; }
        input, select { width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px; color: #1e293b; font-weight: 600; }
        
        /* OLHO SENHA */
        .pass-eye { position: absolute; right: 10px; color: #666; cursor: pointer; padding: 5px; font-size: 16px; }

        /* TELAS */
        .screen { display: none; flex-direction: column; animation: fade 0.3s; background: var(--bg-body); padding-bottom: 80px; width: 100%; min-height: 100vh; }
        .screen.active { display: flex; }
        
        /* LOGIN */
        #screen-login { height: 100vh; overflow: hidden; position: relative; background: black; padding-bottom: 0; z-index: 2000; }
        .login-bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('image_1.png') no-repeat center center; background-size: cover; z-index: 1; pointer-events: none; }
        .login-overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), rgba(0, 56, 168, 0.9)); z-index: 2; pointer-events: none; }
        .login-content-layer { position: relative; z-index: 100; height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; }
        .login-content-layer h1 { margin: 0 auto 5px auto; color: white; font-size: 50px; text-shadow: 0 3px 10px rgba(0,0,0,0.5); font-weight: 900; letter-spacing: -2px; }
        .login-content-layer p { margin: 0 auto 40px auto; color: rgba(255,255,255,0.9); font-size: 12px; font-weight: bold; letter-spacing: 2px; }
        .login-content-layer .input-group { text-align: left; }
        .login-content-layer input { background: rgba(255, 255, 255, 0.95); border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: #000; }
        .login-content-layer label { color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); font-weight: 900; }
        .login-content-layer .checkbox-wrapper { color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 10px;}
        
        /* HEADER */
        .app-header { background: white; padding: 10px 15px; display: none; justify-content: flex-end; align-items: center; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 500; }
        .version-badge { font-size: 10px; font-weight: 900; color: var(--pe-blue); background: #e0e7ff; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--pe-blue); cursor: pointer; }
        .video-header { width: 100%; height: 100px; background: #000; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .video-header iframe { width: 100%; height: 150%; border: none; margin-top: -25px; }

        /* LISTAS & CALENDARIO */
        .section-header-area { background: white; padding: 10px 15px; border-bottom: 1px solid #eee; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .section-title { font-size: 14px; color: var(--pe-blue); font-weight: 900; display: flex; align-items: center; gap: 8px; border-left: 5px solid var(--pe-yellow); padding-left: 10px; }
        .filter-row { display: flex; gap: 5px; }
        .calendar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px; }
        
        /* CARD EVENTO */
        .event-card { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; aspect-ratio: 1 / 1.45; }
        .event-top { background: var(--pe-blue); color: white; padding: 8px; text-align: center; font-weight: 700; font-size: 11px; }
        .event-body { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; text-align: center; }
        .event-title { font-size: 11px; font-weight: 800; color: #1e293b; line-height: 1.3; }
        .card-poster-thumb { width: 100%; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; margin-bottom: 5px; cursor: zoom-in; }
        .event-price { font-size: 10px; font-weight: 900; color: var(--pe-green); background: #dcfce7; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .btn-insc { background: var(--pe-green); color: white; border: none; padding: 8px; font-size: 10px; font-weight: 800; cursor: pointer; width: 100%; border-radius: 4px; margin-top: auto; }
        .btn-share { background: #E1306C; color: white; border: none; padding: 8px; font-size: 10px; font-weight: 800; cursor: pointer; width: 100%; border-radius: 4px; margin-top: auto; }

        /* RANKING */
        .rank-list-container { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; margin: 0 10px; }
        .rank-row { display: flex; align-items: center; padding: 10px 8px; border-bottom: 1px solid #f1f5f9; font-size: 11px; }
        .rank-row:nth-child(even) { background: #f8fafc; }
        .rank-pos { width: 25px; font-weight: 900; color: #64748b; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .rank-row:nth-of-type(1) .rank-pos { color: var(--gold); font-size: 16px; }
        .rank-row:nth-of-type(2) .rank-pos { color: var(--silver); font-size: 14px; }
        .rank-row:nth-of-type(3) .rank-pos { color: var(--bronze); font-size: 14px; }
        .rank-name { flex: 1; font-weight: 700; color: #334155; display: flex; flex-direction: column; padding-left: 5px; }
        .rank-val { font-family: monospace; font-weight: 900; color: var(--pe-blue); background: #e0e7ff; padding: 4px 8px; border-radius: 4px; font-size: 11px; }

        /* ADMIN */
        .admin-dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .adm-dash-btn { background: white; border-radius: 8px; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; text-align: center; border: 1px solid #eee; }
        .adm-dash-btn i { font-size: 24px; color: var(--pe-blue); }
        .admin-item-row { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 10px; }
        .admin-actions { display: flex; gap: 5px; }
        .btn-mini-adm { padding: 4px 8px; border-radius: 4px; border:none; color:white; font-size: 10px; cursor: pointer; }
        .btn-red { background: #ef4444; } .btn-blue { background: #3b82f6; } .btn-green { background: var(--pe-green); }
        .perm-list { display: flex; flex-direction: column; gap: 5px; max-height: 100px; overflow-y: auto; background: #f9f9f9; padding: 5px; border: 1px solid #eee; margin-top: 5px; }
        .pending-row { border-left: 4px solid orange; background: #fff7ed; }
        .pending-tag { font-size: 8px; background: orange; color: white; padding: 2px 4px; border-radius: 2px; margin-left: 5px; }

        /* SEARCHABLE LIST */
        .smart-search-container { position: relative; }
        .smart-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .smart-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 11px; cursor: pointer; }
        .smart-item:hover { background: #f0f9ff; }

        /* TABLE */
        .fin-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px; }
        .fin-table th { background: var(--pe-blue); color: white; padding: 8px; text-align: left; }
        .fin-table td { border-bottom: 1px solid #eee; padding: 8px; background: white; }
        .status-pend { color: #d97706; font-weight: 800; background: #fef3c7; padding: 2px 6px; border-radius: 4px; }
        .status-ok { color: #166534; font-weight: 800; background: #dcfce7; padding: 2px 6px; border-radius: 4px; }
        .stats-box { display: flex; gap: 10px; margin: 10px 0; background: #f0f9ff; padding: 10px; border-radius: 6px; justify-content: space-around; font-size: 10px; font-weight: bold; color: var(--pe-blue); border: 1px solid #bae6fd; }

        /* SHARE INSTAGRAM */
        .share-card { background: linear-gradient(135deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); padding: 30px; border-radius: 15px; color: white; text-align: center; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .share-card h2 { font-size: 28px; margin-bottom: 10px; font-weight: 900; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .share-card p { font-size: 14px; font-weight: 600; margin-bottom: 5px; text-transform: uppercase; }
        .share-badge { background: white; color: #dc2743; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; margin-top: 15px; display: inline-block; }

        /* BARRA INFERIOR */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; display: none; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 9000; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .bar-item { flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; font-weight: 700; cursor: pointer; background: white; }
        .bar-item i { font-size: 20px; margin-bottom: 4px; pointer-events: none; }
        .bar-item.active { color: var(--pe-blue); background: #f0f9ff; border-top: 3px solid var(--pe-red); }

        /* UTILS */
        .btn-icon { background: none; border: none; font-size: 16px; color: #666; cursor: pointer; padding: 5px; }
        .search-area { display: none; margin-top: 5px; animation: fade 0.3s; }
        .login-options { display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 10px; width: 100%; padding: 0 5px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .stories-wrapper { background: var(--pe-blue); border-bottom: 4px solid var(--pe-yellow); overflow: hidden; white-space: nowrap; padding: 8px 0; }
        .stories-track { display: inline-flex; gap: 20px; animation: scrollLeft 20s linear infinite; padding-left: 20px; }
        .story-item { display: flex; flex-direction: column; align-items: center; gap: 3px; width: 50px; flex-shrink: 0; }
        .story-ring { width: 40px; height: 40px; border-radius: 50%; padding: 2px; background: white; }
        .story-img { width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--pe-blue); background: white; display: flex; align-items: center; justify-content: center; overflow: hidden; color: var(--pe-blue); font-weight: bold; font-size: 14px; }
        .story-text { font-size: 8px; font-weight: 600; color: white; text-align: center; }
        @keyframes scrollLeft { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        @keyframes fade { from { opacity:0; } to { opacity:1; } }
        
        /* IMPRESSÃO CONFIGURADA */
        @media print { 
            body * { visibility: hidden; } 
            #printable-area, #printable-area * { visibility: visible; } 
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background:white; }
            .print-cat-block { margin-bottom: 30px; page-break-inside: avoid; }
            .print-table { width: 100%; border-collapse: collapse; font-size: 12px; }
            .print-table th, .print-table td { border: 1px solid #333; padding: 5px; text-align: left; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        }

        /* MODAIS */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 200000; display:none; flex-direction:column; align-items:center; justify-content:center; }
        .modal-box { background: white; width: 90%; max-width: 380px; padding: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-top: 5px solid var(--pe-yellow); border-radius: 8px; max-height: 90vh; overflow-y: auto; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--pe-blue); color: white; padding: 8px 16px; font-size: 11px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300000; font-weight: 600; border-bottom: 3px solid var(--pe-yellow); }
        .toast.show { opacity: 1; top: 60px; }
    </style>
</head>
<body>

<div class="toast" id="toast">MSG</div>
<div id="area-cupom-visual" style="display:none"></div>
<div id="printable-area" style="display:none; padding:20px;"></div>

<div class="modal-overlay" id="modal-share">
    <div class="modal-box" style="background:transparent; box-shadow:none; border:none">
        <div class="share-card">
            <h2>EU VOU!</h2>
            <p>DH-PE 2026</p>
            <p id="share-piloto-name" style="font-size:18px; margin:15px 0">...</p>
            <p id="share-event-name" style="font-size:12px; opacity:0.9">...</p>
            <div class="share-badge">INSCRICÃO CONFIRMADA</div>
        </div>
        <p style="color:white; font-size:11px; margin-bottom:10px">TIRE UM PRINT E POSTE NO INSTAGRAM!</p>
        <button class="btn" style="background:white; color:#333" onclick="fecharModal('modal-share')">FECHAR</button>
    </div>
</div>

<div class="modal-overlay" id="modal-print-options">
    <div class="modal-box">
        <h3 style="color:var(--pe-blue)">IMPRIMIR LISTA</h3>
        <button class="btn" onclick="generatePrint('ALL')">TODAS CATEGORIAS (GERAL)</button>
        <div style="margin:10px 0; border-top:1px solid #eee; padding-top:10px; font-size:10px; font-weight:bold; color:#666">OU POR CATEGORIA:</div>
        <div id="print-cat-list" style="max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:5px;"></div>
        <button class="btn" style="background:#ddd; color:#333; margin-top:10px" onclick="fecharModal('modal-print-options')">CANCELAR</button>
    </div>
</div>

<div class="modal-overlay" id="modal-edit-user">
    <div class="modal-box">
        <h3 style="color:var(--pe-blue)">EDITAR ATLETA</h3>
        <input type="hidden" id="edit-user-original-cpf">
        <div class="input-group"><label>NOME</label><input id="edit-user-name" class="uppercase-input"></div>
        <div class="input-group"><label>CIDADE</label><input id="edit-user-city" class="uppercase-input"></div>
        <div class="input-group"><label>CATEGORIA</label><input id="edit-user-cat"></div>
        <div class="input-group"><label>GÊNERO (M/F)</label><input id="edit-user-gender" maxlength="1" class="uppercase-input"></div>
        <button class="btn" onclick="saveUserEdit()">SALVAR ALTERAÇÕES</button>
        <button class="btn" style="background:#ddd; color:#333; margin-top:5px" onclick="fecharModal('modal-edit-user')">CANCELAR</button>
    </div>
</div>

<div class="modal-overlay" id="modal-poster"><div class="modal-box" style="padding:0; background:black; border:none; width:95%; max-width:400px"><div style="position:relative"><img id="img-poster-view" style="width:100%; display:block"><button onclick="fecharModal('modal-poster')" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; padding:10px; border-radius:50%; cursor:pointer"><i class="fas fa-times"></i></button></div></div></div>
<div class="modal-overlay" id="modal-ticket"><div class="modal-box"><h2 style="color:var(--pe-blue); margin-bottom:5px">TICKET CONFIRMADO</h2><div style="width:50px; height:5px; background:var(--pe-grad); margin:0 auto 15px auto"></div><div style="text-align:left; border:1px dashed #ccc; padding:15px; margin-bottom:15px; background:#f9f9f9"><b style="font-size:10px; color:#999">EVENTO:</b><br><span style="font-size:14px; color:var(--pe-blue); font-weight:900" id="tk-evento">...</span><br><br><b style="font-size:10px; color:#999">PILOTO:</b><br><span style="font-size:12px; color:#333; font-weight:bold" id="tk-nome">...</span></div><button class="btn" onclick="imprimirTicket()"><i class="fas fa-print"></i> IMPRIMIR PDF</button><button class="btn" onclick="fecharModal('modal-ticket')" style="background:#ddd; color:#333; margin-top:5px">FECHAR</button></div></div>

<div class="modal-overlay" id="modal-pix">
    <div class="modal-box">
        <h3 style="color:var(--pe-green)"><i class="fas fa-qrcode"></i> PAGAMENTO</h3>
        <p style="font-size:12px; color:#666; margin:5px 0">VALOR: <b style="color:var(--pe-blue)" id="pix-valor-display">R$ 0,00</b></p>
        <div style="background:#f0fdf4; border:1px dashed var(--pe-green); padding:10px; margin:10px 0; font-size:10px; word-break:break-all; font-weight:bold" id="pix-copy">...</div>
        <button class="btn" style="margin-top:0; background:#64748b" onclick="copiarPix()"><i class="far fa-copy"></i> COPIAR CÓDIGO</button>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0">
        <button class="btn" style="background:#25D366" onclick="enviarComprovanteWhatsApp()"><i class="fab fa-whatsapp"></i> ENVIAR COMPROVANTE</button>
        <button class="btn" style="background:var(--pe-blue); margin-top:5px" onclick="confirmarJaPaguei()"><i class="fas fa-check-circle"></i> JÁ PAGUEI (REGISTRAR)</button>
        <button class="btn" style="background:#ddd; color:#333; margin-top:5px" onclick="fecharModal('modal-pix')">CANCELAR</button>
    </div>
</div>

<div class="modal-overlay" id="modal-info"><div class="modal-box"><h3 id="info-title" style="color:var(--pe-blue)">INFO</h3><p id="info-text" style="font-size:13px; color:#555; margin:15px 0; text-align:left">...</p><button class="btn" onclick="fecharModal('modal-info')" style="background:#ddd; color:#333">FECHAR</button></div></div>

<div class="app-container">
    
    <div id="screen-login" class="screen active">
        <div class="login-bg-layer"></div><div class="login-overlay-layer"></div>
        <div class="login-content-layer">
            <h1>DH-PE</h1><p>CAMPEONATO PERNAMBUCANO</p>
            <div class="input-group"><label>CPF</label><div class="input-wrapper"><input type="tel" id="login-cpf" placeholder="000.000.000-00" oninput="mascaraCPF(this)" maxlength="14"></div></div>
            <div class="input-group"><label>SENHA</label><div class="input-wrapper"><input type="password" id="login-pass" placeholder="••••"><i class="fas fa-eye pass-eye" onclick="togglePass('login-pass')"></i></div></div>
            <div class="checkbox-wrapper"><input type="checkbox" id="login-remember"> MANTER CONECTADO</div>
            <button id="btn-acessar" class="btn" style="background:var(--pe-yellow); color:var(--pe-blue); font-weight:900;" onclick="fazerLogin()">ACESSAR CONTA</button>
            <button class="btn" onclick="trocarTela('cadastro')" style="background:rgba(255,255,255,0.2); color:white; margin-top:10px; border:1px solid rgba(255,255,255,0.3)">CRIAR CONTA</button>
            <p onclick="nuclearReset()" style="margin-top:30px; font-size:10px; color:rgba(255,255,255,0.6); cursor:pointer">RESETAR BANCO</p>
        </div>
    </div>

    <div id="screen-cadastro" class="screen">
        <div style="padding:15px; background:white; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px"><i class="fas fa-arrow-left" onclick="trocarTela('login')" style="font-size:18px; color:#333; cursor:pointer"></i><h2 style="color:var(--pe-blue); margin:0; font-size:16px">CADASTRO</h2></div>
        <div style="width:100%; padding:20px; background:white;">
            <div class="input-group"><label>NOME COMPLETO</label><div class="input-wrapper"><input id="cad-nome" class="uppercase-input"></div></div>
            <div class="input-group"><label>CPF (COM PONTOS)</label><div class="input-wrapper"><input type="tel" id="cad-cpf" oninput="mascaraCPF(this)" maxlength="14"></div></div>
            <div class="input-group"><label>WHATSAPP</label><div class="input-wrapper"><input type="tel" id="cad-tel" oninput="mascaraTel(this)" maxlength="15"></div></div>
            <div class="input-group"><label>CIDADE</label><div class="input-wrapper"><input id="cad-city" class="uppercase-input"></div></div>
            <div class="input-group"><label>GÊNERO</label><select id="cad-gender" onchange="reCalcCat()"><option value="M">MASCULINO</option><option value="F">FEMININO</option></select></div>
            <div class="input-group"><label>DATA NASC.</label><div class="input-wrapper"><input type="date" id="cad-nasc" onchange="reCalcCat()"></div></div>
            <div class="input-group"><label>CATEGORIA</label><div class="input-wrapper"><input id="cad-cat" readonly style="background:#eef2ff; color:#132047; font-weight:900"></div></div>
            <div class="input-group"><label>SENHA</label><div class="input-wrapper"><input type="password" id="cad-pass"><i class="fas fa-eye pass-eye" onclick="togglePass('cad-pass')"></i></div></div>
            <button class="btn" onclick="cadastrar()">CONFIRMAR</button>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <div id="main-app-header" class="app-header">
            <div class="version-badge" onclick="appRefresh()">v28.0</div>
        </div>
        <div class="video-header"><iframe id="main-video-iframe" src="" allow="autoplay; encrypted-media"></iframe></div>
        <div class="stories-wrapper"><div class="stories-track" id="stories-list"></div></div>

        <div id="cont-calendar" class="c-sec active">
            <div class="section-title">CALENDÁRIO 2026</div>
            <div id="list-calendar" class="calendar-grid"></div>
        </div>

        <div id="cont-tempos" class="c-sec" style="display:none">
            <div class="section-header-area">
                <div class="section-title-row">
                    <div class="section-title">TEMPOS</div>
                    <button class="btn-icon" onclick="toggleSearch('tempos')"><i class="fas fa-search"></i></button>
                </div>
                <div class="filter-row">
                    <select id="filter-evt-tempos" onchange="renderContent('tempos')" style="flex:1"><option value="ALL">TODAS ETAPAS</option></select>
                    <select id="filter-cat-tempos" onchange="renderContent('tempos')" style="flex:1"></select>
                </div>
                <div id="search-box-tempos" class="search-area">
                    <input type="text" id="search-input-tempos" placeholder="Buscar..." oninput="renderContent('tempos')">
                </div>
            </div>
            <div class="rank-list-container" id="list-tempos"></div>
        </div>

        <div id="cont-ranking" class="c-sec" style="display:none">
            <div class="section-header-area">
                <div class="section-title-row">
                    <div class="section-title">RANKING</div>
                    <button class="btn-icon" onclick="toggleSearch('ranking')"><i class="fas fa-search"></i></button>
                </div>
                <div class="filter-row">
                    <select id="filter-evt-ranking" onchange="renderContent('ranking')" style="flex:1"><option value="ALL">GERAL (SOMA)</option></select>
                    <select id="filter-cat-ranking" onchange="renderContent('ranking')" style="flex:1"></select>
                </div>
                <div id="search-box-ranking" class="search-area">
                    <input type="text" id="search-input-ranking" placeholder="Buscar..." oninput="renderContent('ranking')">
                </div>
            </div>
            <div class="rank-list-container" id="list-ranking"></div>
        </div>

        <div id="cont-adm" class="c-sec" style="display:none; padding:10px">
            <div class="section-title" style="color:var(--pe-red)">PAINEL ADMIN</div>
            <div id="adm-login-box">
                <div class="input-group"><label>SENHA DE SEGURANÇA</label><div class="input-wrapper"><input type="password" id="adm-pass-check"></div></div>
                <button class="btn" style="background:var(--pe-red)" onclick="checkAdmPass()">LIBERAR</button>
            </div>
            
            <div id="adm-panel-real" style="display:none">
                <div class="admin-dashboard-grid" id="adm-menu">
                    <div class="adm-dash-btn" onclick="openAdmSection('events')"><i class="far fa-calendar-plus"></i><span>GERENCIAR EVENTOS</span></div>
                    <div class="adm-dash-btn" onclick="openAdmSection('results')"><i class="fas fa-stopwatch"></i><span>LANÇAR RESULTADOS</span></div>
                    <div class="adm-dash-btn" id="btn-menu-org" onclick="openAdmSection('organizer')"><i class="fas fa-users-cog"></i><span>EQUIPE</span></div>
                    <div class="adm-dash-btn" onclick="openAdmSection('financial')"><i class="fas fa-file-invoice-dollar"></i><span>STATUS DE ATLETAS</span></div>
                    <div class="adm-dash-btn" onclick="openAdmSection('users-edit')"><i class="fas fa-user-edit"></i><span>ATLETAS</span></div>
                    <div class="adm-dash-btn" onclick="openAdmSection('config')"><i class="fas fa-cogs"></i><span>CONFIGURAÇÕES</span></div>
                </div>

                <div id="adm-sec-events" style="display:none">
                    <button class="btn" style="background:#999; margin-bottom:10px" onclick="backToAdmMenu()">VOLTAR</button>
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-blue); font-size:12px">CRIAR/EDITAR EVENTO</b>
                        <input type="hidden" id="adm-evt-id-edit">
                        <input id="adm-evt-t" placeholder="NOME DO EVENTO" class="uppercase-input" style="margin-top:5px">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px">
                            <select id="adm-evt-month"><option value="JAN">JAN</option><option value="FEV">FEV</option><option value="MAR">MAR</option><option value="ABR">ABR</option><option value="MAI">MAI</option><option value="JUN">JUN</option><option value="JUL">JUL</option><option value="AGO">AGO</option><option value="SET">SET</option><option value="OUT">OUT</option><option value="NOV">NOV</option><option value="DEZ">DEZ</option></select>
                            <input id="adm-evt-d" placeholder="DIAS (00/00)" oninput="mascaraData(this)" maxlength="5">
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px">
                            <input id="adm-evt-c" placeholder="CIDADE" class="uppercase-input">
                            <input id="adm-evt-v" placeholder="VALOR (R$)" type="tel">
                        </div>
                        <div style="margin-top:5px"><label style="font-size:9px; font-weight:bold; color:#666">CARTAZ</label><input type="file" id="adm-evt-img" accept="image/*"></div>
                        <div style="display:flex; gap:10px; margin:10px 0; font-size:10px; font-weight:bold"><label><input type="checkbox" id="adm-evt-cb-pe" checked> ESTADUAL</label><label><input type="checkbox" id="adm-evt-cb-cbc"> CBC</label></div>
                        <button class="btn" id="btn-save-event" style="padding:8px; margin:0" onclick="addEvent()">SALVAR</button>
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:5px"><p style="font-size:9px; color:#999">LISTA</p><div id="adm-list-events"></div></div>
                    </div>
                </div>

                <div id="adm-sec-results" style="display:none">
                    <button class="btn" style="background:#999; margin-bottom:10px" onclick="backToAdmMenu()">VOLTAR</button>
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-green); font-size:12px">LANÇAR RESULTADOS</b>
                        <input type="hidden" id="adm-res-index-edit">
                        <input type="hidden" id="adm-res-type-edit">
                        <select id="adm-res-evt" style="margin-top:5px; font-size:10px; font-weight:bold; color:var(--pe-blue)"><option value="">SELECIONE O EVENTO...</option></select>
                        <div style="display:flex; gap:5px; margin-top:5px">
                            <select id="adm-res-type" style="width:auto"><option value="tempos">TEMPO</option><option value="ranking">RANKING</option></select>
                            <select id="adm-res-id" style="flex:1; font-size:10px"></select>
                        </div>
                        <div class="smart-search-container" style="margin-top:5px">
                            <input type="text" id="adm-res-search" placeholder="DIGITE NOME, CPF OU CIDADE..." oninput="filterPilots('res')" autocomplete="off">
                            <div id="adm-res-list" class="smart-list"></div>
                            <input type="hidden" id="adm-res-id"> 
                        </div>
                        <input id="adm-res-val" placeholder="00:00.000 / PTS" oninput="maskTimeOrPoints(this)" style="margin-top:5px">
                        <button class="btn" id="btn-save-res" style="width:100%; margin-top:5px; background:var(--pe-green)" onclick="addResult()">LANÇAR</button>
                        <button class="btn" id="btn-cancel-res" style="width:100%; margin-top:5px; background:#999; display:none" onclick="cancelEditRes()">CANCELAR</button>
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:5px"><p style="font-size:9px; color:#999">ÚLTIMOS</p><div id="adm-list-results" style="max-height:150px; overflow-y:auto"></div></div>
                    </div>
                </div>

                <div id="adm-sec-organizer" style="display:none">
                    <button class="btn" style="background:#999; margin-bottom:10px" onclick="backToAdmMenu()">VOLTAR</button>
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-blue); font-size:12px">CADASTRAR ORGANIZADOR</b>
                        <div class="smart-search-container" style="margin-top:20px; margin-bottom:10px; border-top:1px solid #eee; padding-top:10px">
                             <label style="font-size:9px; font-weight:bold; color:#666">BUSCAR ATLETA PARA PROMOVER:</label>
                            <input type="text" id="adm-org-search" placeholder="DIGITE NOME DO ATLETA..." oninput="filterPilots('org')" autocomplete="off">
                            <div id="adm-org-list-search" class="smart-list"></div>
                            <input type="hidden" id="adm-org-selected-cpf">
                        </div>
                        <div id="org-perms-area" style="display:none">
                            <p style="font-size:10px;font-weight:bold;margin:10px 0 5px 0">PERMISSÃO DE ETAPAS:</p>
                            <div id="org-events-list" class="perm-list"></div>
                            <button class="btn" style="background:#666; margin-top:10px" onclick="promoteToOrganizer()">PROMOVER SELECIONADO</button>
                        </div>
                        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:5px">
                            <b style="font-size:10px; color:#666">LISTA DE ORGANIZADORES</b>
                            <div id="adm-list-orgs" style="max-height:150px; overflow-y:auto"></div>
                        </div>
                    </div>
                </div>

                <div id="adm-sec-users-edit" style="display:none">
                    <button class="btn" style="background:#999; margin-bottom:10px" onclick="backToAdmMenu()">VOLTAR</button>
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                            <b style="color:var(--pe-blue); font-size:12px">ATLETAS (EDITAR)</b>
                            <button class="btn-icon" onclick="toggleUserSearch()"><i class="fas fa-eye-slash"></i></button>
                        </div>
                         <div id="adm-user-search-wrapper" class="smart-search-container" style="margin-top:10px; margin-bottom:10px;">
                            <input type="text" id="adm-edit-user-search" placeholder="BUSCAR POR NOME, CPF OU CIDADE..." oninput="filterPilots('edit-user')" autocomplete="off">
                            <div id="adm-edit-user-list" class="smart-list"></div>
                        </div>
                        <p style="font-size:10px; color:#999; text-align:center">Clique no nome para abrir edição completa</p>
                    </div>
                </div>

                <div id="adm-sec-financial" style="display:none">
                    <button class="btn" style="background:#999; margin-bottom:10px" onclick="backToAdmMenu()">VOLTAR</button>
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-blue); font-size:12px">STATUS DE ATLETAS</b>
                        <select id="fin-evt-select" style="margin:10px 0" onchange="renderInscriptions()"><option value="">SELECIONE O EVENTO...</option></select>
                        <div class="stats-box">
                            <span id="stat-total">Total: 0</span>
                            <span id="stat-paid" style="color:green">Pagos: 0</span>
                            <span id="stat-money">R$ 0,00</span>
                        </div>
                        <div style="display:flex;gap:5px;margin-bottom:5px">
                            <button class="btn-mini-adm" style="background:#ccc;color:#333;flex:1" onclick="filterFinList('ALL')">TODOS</button>
                            <button class="btn-mini-adm btn-green" style="flex:1" onclick="filterFinList('CONFIRMADO')">PAGOS</button>
                            <button class="btn-mini-adm" style="background:orange;flex:1" onclick="filterFinList('PENDENTE')">PEND</button>
                        </div>
                        <div id="fin-list-container"></div>
                        <button class="btn" style="margin-top:10px; background:#333" onclick="openPrintOptions()"><i class="fas fa-print"></i> IMPRIMIR LISTA</button>
                    </div>
                </div>

                <div id="adm-sec-config" style="display:none">
                    <button class="btn" style="background:#999; margin-bottom:10px" onclick="backToAdmMenu()">VOLTAR</button>
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-blue); font-size:12px">CONFIGURAÇÕES</b>
                        <div class="input-group" style="margin-top:15px">
                            <label>ID VÍDEO YOUTUBE (ex: dQw4w9WgXcQ)</label>
                            <input id="cfg-video-id">
                        </div>
                        <button class="btn" onclick="saveVideoConfig()">SALVAR CONFIGURAÇÃO</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="bottom-bar" id="main-nav-bar">
        <div class="bar-item active" onclick="nav('calendar')" id="btn-calendar"><i class="far fa-calendar-alt"></i><span>CAL</span></div>
        <div class="bar-item" onclick="nav('tempos')" id="btn-tempos"><i class="fas fa-stopwatch"></i><span>TEMPO</span></div>
        <div class="bar-item" onclick="nav('ranking')" id="btn-ranking"><i class="fas fa-trophy"></i><span>RANK</span></div>
        <div class="bar-item" id="btn-adm-nav" onclick="tryOpenAdmin()"><i class="fas fa-user-shield"></i><span>ADM</span></div>
        <div class="bar-item" ontouchstart="fazerLogout()" onclick="fazerLogout()"><i class="fas fa-sign-out-alt"></i><span>SAIR</span></div>
    </div>

</div>

<script>
    window.onerror = function(msg, url, line) { alert("ERRO: " + msg + "\nLinha: " + line); return true; };
    function appRefresh() { window.location.reload(true); }

    // --- 1. DEFINIÇÕES GLOBAIS ---
    const DB_KEY = 'dhpe_v28_0_db'; const SESS_KEY = 'dhpe_sess_v28_0'; const REMEMBER_KEY = 'dhpe_remember_token_v280';
    const ADMIN_CPF = "083.276.324-18"; const ADMIN_PASS = "0800"; // FORMATADO

    // ADMIN BASE
    const usersList = [{ nome: "ABRAAO EVERTON LOPES DE ARAUJO", cpf: ADMIN_CPF, pass: ADMIN_PASS, cat: "ORGANIZAÇÃO", tel: "", city: "RECIFE", gender:"M", role: "ADMIN", allowedEvts: [], inscricoes: [] }];
    
    // BANCO ZERADO
    const DEFAULT_DB = {
        users: usersList,
        events: [
            { id:1, d:'25/26', m:'ABR', city:'OURICURI-PE', t:'1ª ETAPA ESTADUAL', val: "100,00", est:true, cbc:false, open:true, img:null },
            { id:2, d:'16/17', m:'MAI', city:'CARUARU-PE', t:'2ª ETAPA ESTADUAL', val: "100,00", est:true, cbc:false, open:true, img:null }
        ],
        tempos: [], ranking: [],
        config: { logo: 'logo-fp.jpg', videoId: 'dQw4w9WgXcQ' },
        stories: [ { title: 'REGRAS', icon: 'fa-book' }, { title: 'MAXXIS', icon: 'fa-star' }, { title: 'FPC', icon: 'fa-flag' } ]
    };

    function cleanCPF(v) { return v ? v.replace(/\D/g, "") : ""; } 
    
    function mascaraCPF(i) {
        let v = i.value.replace(/\D/g, "");
        if (v.length > 11) v = v.substring(0, 11);
        i.value = v.replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d{1,2})$/, "$1-$2");
    }
    
    function mascaraTel(i) {
        let v = i.value.replace(/\D/g, "");
        if (v.length > 11) v = v.substring(0, 11);
        v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
        v = v.replace(/(\d)(\d{4})$/, "$1-$2");
        i.value = v;
    }

    function mascaraData(i) { let v = i.value.replace(/\D/g,""); if(v.length > 4) v = v.substring(0,4); if(v.length > 2) v = v.substring(0,2) + '/' + v.substring(2); i.value = v; }
    function togglePass(id) { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }

    let db; try { db = JSON.parse(localStorage.getItem(DB_KEY)); if(!db) throw new Error("DB empty"); } catch(e) { db = DEFAULT_DB; saveDB(); }
    
    // Ensure Admin
    const adminIndex = db.users.findIndex(u => cleanCPF(u.cpf) === cleanCPF(ADMIN_CPF));
    if(adminIndex >= 0) { db.users[adminIndex].role = "ADMIN"; db.users[adminIndex].pass = ADMIN_PASS; } else { db.users.push(DEFAULT_DB.users[0]); }
    saveDB();

    let currentTab = 'calendar'; let loggedUser = null;
    let currentPayId = null;

    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function getUser() { return JSON.parse(localStorage.getItem(SESS_KEY)); }
    function toast(m) { const t=document.getElementById('toast'); t.innerText=m.toUpperCase(); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    
    function trocarTela(id) { 
        document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')); 
        document.getElementById('screen-'+id).classList.add('active'); 
        if(id === 'app') {
            document.getElementById('main-nav-bar').style.display = 'flex';
            document.getElementById('main-app-header').style.display = 'flex';
            // Load Video
            if(db.config && db.config.videoId) {
                document.getElementById('main-video-iframe').src = `https://www.youtube.com/embed/${db.config.videoId}?autoplay=1&mute=1&controls=0&loop=1&playlist=${db.config.videoId}`;
            }
        } else {
            document.getElementById('main-nav-bar').style.display = 'none';
            document.getElementById('main-app-header').style.display = 'none';
        }
    }

    function toggleSearch(id) { const el = document.getElementById('search-box-'+id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
    function toggleUserSearch() { const el = document.getElementById('adm-user-search-wrapper'); el.style.display = el.style.display === 'none' ? 'block' : 'none'; }

    function nav(t) {
        if(t === 'adm' && (!loggedUser || (loggedUser.role !== 'ADMIN' && loggedUser.role !== 'ORGANIZER'))) return toast("ACESSO NEGADO");
        currentTab = t;
        document.querySelectorAll('.bar-item').forEach(b => b.classList.remove('active'));
        if(document.getElementById('btn-'+t)) document.getElementById('btn-'+t).classList.add('active');
        document.querySelectorAll('.c-sec').forEach(e => e.style.display='none');
        document.getElementById('cont-'+t).style.display='block';
        if(t === 'adm') { 
            if(loggedUser.role === 'ADMIN' || loggedUser.role === 'ORGANIZER') {
                document.getElementById('adm-login-box').style.display='none';
                document.getElementById('adm-panel-real').style.display='block';
                backToAdmMenu(); 
            } else {
                document.getElementById('adm-pass-check').value = ''; document.getElementById('adm-panel-real').style.display = 'none'; document.getElementById('adm-login-box').style.display = 'block';
            }
        } else { renderContent(t); }
    }
    
    function tryOpenAdmin() { if(loggedUser && (loggedUser.role === 'ADMIN' || loggedUser.role === 'ORGANIZER')) nav('adm'); else alert("Apenas Organizadores."); }

    function renderStories() {
        try {
            const div = document.getElementById('stories-list');
            const items = [...db.stories, ...db.stories]; 
            div.innerHTML = items.map(s => `<div class="story-item"><div class="story-ring"><div class="story-img"><i class="fas ${s.icon}"></i></div></div><div class="story-text">${s.title}</div></div>`).join('');
        } catch(e) { console.log(e); }
    }

    function renderContent(t) {
        if(t === 'calendar') {
            const div = document.getElementById('list-calendar');
            div.innerHTML = db.events.map(e => {
                const btnPoster = e.img ? `<img src="${e.img}" class="card-poster-thumb" onclick="verCartaz('${e.id}')">` : '';
                const valShow = e.val ? `<div class="event-price">R$ ${e.val}</div>` : '';
                // Check status
                let actionBtn = `<button class="btn-insc" onclick="iniciarInscricao('${e.id}','${e.t}', '${e.val}')">INSCREVER</button>`;
                if(loggedUser) {
                    const ins = loggedUser.inscricoes.find(i => i.id == e.id);
                    if(ins && ins.status === 'CONFIRMADO') {
                        actionBtn = `<button class="btn-share" onclick="openShareModal('${e.t}')"><i class="fab fa-instagram"></i> COMPARTILHAR</button>`;
                    } else if(ins) {
                        actionBtn = `<button class="btn-insc" style="background:orange">PENDENTE</button>`;
                    }
                }

                return `<div class="event-card ${e.open?'':'closed'}"><div class="event-top"><span class="event-date">${e.d} ${e.m}</span></div><div class="event-body"><div class="event-title">${e.t}</div>${btnPoster}${valShow}<div class="event-city"><i class="fas fa-map-marker-alt"></i> ${e.city}</div><div class="badge-box">${e.est?'<span class="badge b-est">PE</span>':''}${e.cbc?'<span class="badge b-cbc">CBC</span>':''}</div>${actionBtn}</div></div>`;
            }).join('');
        } else if (t === 'tempos' || t === 'ranking') {
            const list = db[t];
            const div = document.getElementById('list-'+t);
            const selCat = document.getElementById('filter-cat-'+t);
            const selEvt = document.getElementById('filter-evt-'+t);
            const searchVal = document.getElementById('search-input-'+t).value.toUpperCase();

            if(selCat.innerHTML === '') { const cats = [...new Set(list.map(i => i.cat))]; selCat.innerHTML = `<option value="ALL">TODAS CATEGORIAS</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join(''); }
            if(selEvt.innerHTML === '' || (selEvt.options.length === 1 && t === 'tempos')) { const evts = db.events; let opts = t==='ranking' ? `<option value="ALL">GERAL (SOMA)</option>` : `<option value="ALL">TODAS ETAPAS</option>`; opts += evts.map(e => `<option value="${e.id}">${e.t}</option>`).join(''); selEvt.innerHTML = opts; }

            let filtered = list;
            filtered = filtered.filter(i => i.status === 'OK');

            if(selCat.value !== 'ALL') filtered = filtered.filter(i => i.cat === selCat.value);
            if(selEvt.value !== 'ALL') filtered = filtered.filter(i => i.evtId == selEvt.value);
            if(searchVal) filtered = filtered.filter(i => i.name.includes(searchVal) || (i.city && i.city.includes(searchVal)) || (i.name.includes(searchVal)));

            div.innerHTML = filtered.map((r, i) => `<div class="rank-row"><div class="rank-pos">${i+1}</div><div class="rank-name">${r.name}<span class="rank-cat">${r.cat} - ${r.city}</span></div><div class="rank-val">${r.val}</div></div>`).join('');
        }
    }

    function openAdmSection(sec) {
        document.getElementById('adm-menu').style.display = 'none';
        if(sec === 'events') { document.getElementById('adm-sec-events').style.display='block'; refreshAdmLists(); }
        if(sec === 'results') { 
            document.getElementById('adm-sec-results').style.display='block'; refreshAdmLists(); 
            const selEvt = document.getElementById('adm-res-evt'); selEvt.innerHTML = '<option value="">SELECIONE EVENTO...</option>' + db.events.map(e => `<option value="${e.id}">${e.t}</option>`).join('');
        }
        if(sec === 'organizer') {
            document.getElementById('adm-sec-organizer').style.display='block';
            document.getElementById('org-events-list').innerHTML = db.events.map(e => `<label class="perm-item"><input type="checkbox" value="${e.id}" class="perm-cb"> ${e.t}</label>`).join('');
            renderOrgList();
        }
        if(sec === 'users-edit') {
             document.getElementById('adm-sec-users-edit').style.display='block';
        }
        if(sec === 'config') {
             document.getElementById('adm-sec-config').style.display='block';
             document.getElementById('cfg-video-id').value = db.config.videoId || '';
        }
        if(sec === 'financial') { 
            document.getElementById('adm-sec-financial').style.display='block'; 
            const sel = document.getElementById('fin-evt-select'); 
            let availableEvents = db.events;
            if(loggedUser.role === 'ORGANIZER' && loggedUser.allowedEvts) {
                availableEvents = db.events.filter(e => loggedUser.allowedEvts.includes(e.id.toString()));
            }
            sel.innerHTML = '<option value="">SELECIONE O EVENTO...</option>' + availableEvents.map(e => `<option value="${e.id}">${e.t}</option>`).join(''); 
        }
    }

    function backToAdmMenu() {
        document.getElementById('adm-sec-events').style.display='none'; document.getElementById('adm-sec-results').style.display='none';
        document.getElementById('adm-sec-organizer').style.display='none'; document.getElementById('adm-sec-financial').style.display='none';
        document.getElementById('adm-sec-users-edit').style.display='none'; document.getElementById('adm-sec-config').style.display='none';
        document.getElementById('adm-menu').style.display='grid';
    }

    function checkAdmPass() { if(document.getElementById('adm-pass-check').value === ADMIN_PASS) { document.getElementById('adm-login-box').style.display='none'; document.getElementById('adm-panel-real').style.display='block'; backToAdmMenu(); } else { toast("SENHA INVÁLIDA"); } }
    
    // --- SMART SEARCH (ALL USERS) ---
    function filterPilots(ctx) {
        const inputId = ctx === 'res' ? 'adm-res-search' : (ctx === 'org' ? 'adm-org-search' : 'adm-edit-user-search');
        const listId = ctx === 'res' ? 'adm-res-list' : (ctx === 'org' ? 'adm-org-list-search' : 'adm-edit-user-list');
        const text = document.getElementById(inputId).value.toUpperCase();
        const listDiv = document.getElementById(listId);
        
        listDiv.innerHTML = '';
        if(text.length < 2) { listDiv.style.display = 'none'; return; }
        
        // SEARCH ALL (INCLUDING SELF)
        const filtered = db.users.filter(u => (u.nome.includes(text) || u.cpf.includes(text) || u.city.includes(text)));
        
        if(filtered.length === 0) { listDiv.style.display='none'; return; }
        
        listDiv.style.display = 'block';
        listDiv.innerHTML = filtered.map(u => `
            <div class="smart-item" onclick="selectPilot('${u.cpf}', '${u.nome}', '${ctx}')">
                <b>${u.nome}</b><br><span style="color:#666">${u.cat} | ${u.cpf}</span>
            </div>
        `).join('');
    }

    function selectPilot(cpf, name, ctx) {
        if(ctx === 'res') {
            document.getElementById('adm-res-id').value = cpf;
            document.getElementById('adm-res-search').value = name;
            document.getElementById('adm-res-list').style.display = 'none';
        } else if(ctx === 'org') {
            document.getElementById('adm-org-selected-cpf').value = cpf;
            document.getElementById('adm-org-search').value = name;
            document.getElementById('adm-org-list-search').style.display = 'none';
            document.getElementById('org-perms-area').style.display = 'block';
        } else if(ctx === 'edit-user') {
            openEditUserModal(cpf);
        }
    }

    // --- EDIT USER ---
    function openEditUserModal(cpf) {
        const u = db.users.find(x => x.cpf === cpf);
        if(u) {
            document.getElementById('edit-user-original-cpf').value = u.cpf;
            document.getElementById('edit-user-name').value = u.nome;
            document.getElementById('edit-user-city').value = u.city;
            document.getElementById('edit-user-cat').value = u.cat;
            document.getElementById('edit-user-gender').value = u.gender || 'M';
            document.getElementById('modal-edit-user').style.display = 'flex';
        }
    }

    function saveUserEdit() {
        const cpf = document.getElementById('edit-user-original-cpf').value;
        const idx = db.users.findIndex(x => x.cpf === cpf);
        if(idx > -1) {
            db.users[idx].nome = document.getElementById('edit-user-name').value.toUpperCase();
            db.users[idx].city = document.getElementById('edit-user-city').value.toUpperCase();
            db.users[idx].cat = document.getElementById('edit-user-cat').value.toUpperCase();
            db.users[idx].gender = document.getElementById('edit-user-gender').value.toUpperCase();
            saveDB();
            toast("DADOS ATUALIZADOS");
            fecharModal('modal-edit-user');
        }
    }

    // --- ORGANIZER LOGIC ---
    function promoteToOrganizer() {
        const cpf = document.getElementById('adm-org-selected-cpf').value;
        if(!cpf) return toast("SELECIONE UM ATLETA");
        
        const perms = []; document.querySelectorAll('.perm-cb:checked').forEach(cb => perms.push(cb.value));
        const idx = db.users.findIndex(u => u.cpf === cpf);
        
        if(idx > -1) {
            db.users[idx].role = 'ORGANIZER';
            db.users[idx].allowedEvts = perms;
            db.users[idx].cat = "ORGANIZAÇÃO";
            saveDB();
            toast("PROMOVIDO!");
            document.getElementById('adm-org-search').value = '';
            document.getElementById('org-perms-area').style.display = 'none';
            renderOrgList();
        }
    }

    function demoteOrganizer(cpf) {
        if(confirm("REMOVER PERMISSÃO DE ORGANIZADOR?")) {
            const idx = db.users.findIndex(u => u.cpf === cpf);
            if(idx > -1) {
                db.users[idx].role = 'USER';
                db.users[idx].cat = "RÍGIDA"; // Or Recalc
                db.users[idx].allowedEvts = [];
                saveDB(); renderOrgList();
            }
        }
    }

    function renderOrgList() {
        const orgs = db.users.filter(u => u.role === 'ORGANIZER');
        document.getElementById('adm-list-orgs').innerHTML = orgs.map(o => `
            <div class="admin-item-row">
                <span>${o.nome}</span>
                <div class="admin-actions">
                    <button class="btn-mini-adm btn-red" onclick="demoteOrganizer('${o.cpf}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    }
    
    // --- FINANCIAL ---
    let currentFilterStatus = 'ALL';
    function filterFinList(status) {
        currentFilterStatus = status;
        renderInscriptions();
    }

    function renderInscriptions() {
        const evtId = document.getElementById('fin-evt-select').value;
        const div = document.getElementById('fin-list-container');
        if(!evtId) return div.innerHTML = '';
        
        let totalCount = 0; let paidCount = 0; let totalMoney = 0;
        let html = '<table class="fin-table"><thead><tr><th>NOME</th><th>STATUS</th><th>AÇÃO</th></tr></thead><tbody>';
        
        db.users.forEach(u => {
            const insc = u.inscricoes.find(i => i.id == evtId);
            if(insc) {
                totalCount++;
                if(insc.status === 'CONFIRMADO') { paidCount++; }
                
                // FILTER
                if(currentFilterStatus !== 'ALL' && insc.status !== currentFilterStatus) return;

                const statusClass = insc.status === 'CONFIRMADO' ? 'status-ok' : 'status-pend';
                const confirmedBy = insc.confirmedBy ? `<br><span style="font-size:8px;color:green">APROV: ${insc.confirmedBy}</span>` : '';
                const btn = insc.status !== 'CONFIRMADO' ? `<button class="btn-mini-adm btn-green" onclick="confirmPay('${u.cpf}', '${evtId}')">CONFIRMAR</button>` : '';
                
                html += `<tr><td>${u.nome}<br><span style="color:#666;font-size:9px">${u.cat}</span></td><td><span class="${statusClass}">${insc.status}</span>${confirmedBy}</td><td>${btn}</td></tr>`;
            }
        });
        
        const evt = db.events.find(e => e.id == evtId);
        const val = evt.val ? parseFloat(evt.val.replace(',','.')) : 0;
        totalMoney = paidCount * val;

        document.getElementById('stat-total').innerText = `Total: ${totalCount}`;
        document.getElementById('stat-paid').innerText = `Pagos: ${paidCount}`;
        document.getElementById('stat-money').innerText = `R$ ${totalMoney.toFixed(2)}`;

        div.innerHTML = html + '</tbody></table>';
    }

    function confirmPay(userCpf, evtId) { 
        const u = db.users.find(x => x.cpf === userCpf); 
        const ins = u.inscricoes.find(i => i.id == evtId); 
        if(ins) { 
            ins.status = 'CONFIRMADO'; 
            ins.confirmedBy = loggedUser.nome.split(' ')[0]; 
            saveDB(); renderInscriptions(); toast("CONFIRMADO!"); 
        } 
    }

    // --- PRINT REPORT & OPTIONS ---
    function openPrintOptions() {
        const evtId = document.getElementById('fin-evt-select').value;
        if(!evtId) return toast("SELECIONE O EVENTO");
        
        // Get categories from enrolled users
        let cats = new Set();
        db.users.forEach(u => {
            if(u.inscricoes.some(i => i.id == evtId)) cats.add(u.cat);
        });
        
        const listDiv = document.getElementById('print-cat-list');
        listDiv.innerHTML = Array.from(cats).map(c => 
            `<button class="btn-mini-adm" style="text-align:left; padding:8px; width:100%" onclick="generatePrint('${c}')">${c}</button>`
        ).join('');
        
        document.getElementById('modal-print-options').style.display = 'flex';
    }

    function generatePrint(categoryFilter) {
        const evtId = document.getElementById('fin-evt-select').value;
        const evt = db.events.find(e => e.id == evtId);
        
        let usersIn = [];
        db.users.forEach(u => {
            const insc = u.inscricoes.find(i => i.id == evtId);
            if(insc) {
                // Filter by Category if needed
                if(categoryFilter === 'ALL' || u.cat === categoryFilter) {
                    usersIn.push({ ...u, status: insc.status });
                }
            }
        });

        const grouped = {};
        usersIn.forEach(u => {
            if(!grouped[u.cat]) grouped[u.cat] = [];
            grouped[u.cat].push(u);
        });

        let html = `<div class="print-header"><h1>${evt.t}</h1><p>RELATÓRIO: ${categoryFilter === 'ALL' ? 'GERAL' : categoryFilter}</p></div>`;
        
        for (const cat in grouped) {
            html += `<div class="print-cat-block"><h3>${cat}</h3>
            <table class="print-table"><thead><tr><th>NOME</th><th>CIDADE</th><th>CPF</th><th>STATUS</th></tr></thead><tbody>`;
            grouped[cat].forEach(u => {
                html += `<tr><td>${u.nome}</td><td>${u.city}</td><td>${u.cpf}</td><td>${u.status}</td></tr>`;
            });
            html += `</tbody></table></div>`;
        }
        
        document.getElementById('printable-area').innerHTML = html;
        fecharModal('modal-print-options');
        window.print();
    }
    
    // --- SHARE INSTAGRAM ---
    function openShareModal(evtName) {
        document.getElementById('share-piloto-name').innerText = loggedUser.nome;
        document.getElementById('share-event-name').innerText = evtName;
        document.getElementById('modal-share').style.display = 'flex';
    }

    // --- VIDEO CONFIG ---
    function saveVideoConfig() {
        const vid = document.getElementById('cfg-video-id').value;
        if(vid) {
            db.config.videoId = vid;
            saveDB();
            toast("VÍDEO ATUALIZADO");
        }
    }
    
    function refreshAdmLists() { 
        document.getElementById('adm-list-events').innerHTML = db.events.map((e, i) => `<div class="admin-item-row"><span>${e.t}</span><div class="admin-actions"><button class="btn-mini-adm btn-blue" onclick="editEvent(${e.id})"><i class="fas fa-pen"></i></button><button class="btn-mini-adm btn-red" onclick="delItem('events', ${i})"><i class="fas fa-trash"></i></button></div></div>`).join(''); 
        document.getElementById('adm-list-results').innerHTML = db.tempos.map((t, i) => {
            const approveBtn = (t.status === 'PENDING' && loggedUser.role === 'ADMIN') ? `<button class="btn-mini-adm btn-green" onclick="approveResult('tempos', ${i})">✅</button>` : '';
            const statusTag = t.status === 'PENDING' ? '<span class="pending-tag">PENDENTE</span>' : '';
            return `<div class="admin-item-row ${t.status==='PENDING'?'pending-row':''}"><span>${t.name} - ${t.val}${statusTag}</span><div class="admin-actions">${approveBtn}<button class="btn-mini-adm btn-blue" onclick="editResult('tempos', ${i})"><i class="fas fa-pen"></i></button><button class="btn-mini-adm btn-red" onclick="delItem('tempos', ${i})"><i class="fas fa-trash"></i></button></div></div>`;
        }).join(''); 
    }
    
    function editEvent(id) { const evt = db.events.find(e => e.id == id); if(evt) { document.getElementById('adm-evt-id-edit').value = evt.id; document.getElementById('adm-evt-t').value = evt.t; document.getElementById('adm-evt-month').value = evt.m; document.getElementById('adm-evt-d').value = evt.d; document.getElementById('adm-evt-c').value = evt.city; document.getElementById('adm-evt-v').value = evt.val || ''; document.getElementById('btn-save-event').innerText = "ATUALIZAR"; } }
    
    function addEvent() { 
        const idEdit = document.getElementById('adm-evt-id-edit').value; const t = document.getElementById('adm-evt-t').value.toUpperCase(); const m = document.getElementById('adm-evt-month').value; const d = document.getElementById('adm-evt-d').value; const c = document.getElementById('adm-evt-c').value.toUpperCase(); const v = document.getElementById('adm-evt-v').value; const imgInput = document.getElementById('adm-evt-img');
        const save = (imgData) => {
            if(t && d && c) {
                if(idEdit) { const idx = db.events.findIndex(e => e.id == idEdit); if(idx > -1) { db.events[idx] = { ...db.events[idx], t, m, d, city:c, val:v }; if(imgData) db.events[idx].img = imgData; toast("ATUALIZADO"); } } 
                else { db.events.push({id:Date.now(), t, d, m, city:c, val:v, est:document.getElementById('adm-evt-cb-pe').checked, cbc:document.getElementById('adm-evt-cb-cbc').checked, open:true, img: imgData}); toast("CRIADO"); }
                saveDB(); refreshAdmLists(); 
                document.getElementById('adm-evt-t').value=''; document.getElementById('adm-evt-d').value=''; document.getElementById('adm-evt-c').value=''; document.getElementById('adm-evt-v').value=''; document.getElementById('adm-evt-id-edit').value=''; document.getElementById('btn-save-event').innerText='SALVAR';
            }
        };
        if(imgInput.files[0]) { const r = new FileReader(); r.onload = (e) => save(e.target.result); r.readAsDataURL(imgInput.files[0]); } else { save(null); }
    }

    function editResult(type, index) { const res = db[type][index]; if(res) { document.getElementById('adm-res-index-edit').value = index; document.getElementById('adm-res-type-edit').value = type; document.getElementById('adm-res-type').value = type; document.getElementById('adm-res-evt').value = res.evtId; const u = db.users.find(u => u.nome === res.name); if(u) { document.getElementById('adm-res-id').value = u.cpf; document.getElementById('adm-res-search').value = u.nome; } document.getElementById('adm-res-val').value = res.val; document.getElementById('btn-save-res').innerText = "ATUALIZAR"; document.getElementById('btn-cancel-res').style.display = 'block'; } }
    function cancelEditRes() { document.getElementById('adm-res-index-edit').value=''; document.getElementById('adm-res-val').value=''; document.getElementById('adm-res-search').value=''; document.getElementById('btn-save-res').innerText='LANÇAR'; document.getElementById('btn-cancel-res').style.display='none'; }

    function addResult() { 
        const idx = document.getElementById('adm-res-index-edit').value; const type = document.getElementById('adm-res-type').value; const evtId = document.getElementById('adm-res-evt').value; const cpf = document.getElementById('adm-res-id').value; const val = document.getElementById('adm-res-val').value; if(!evtId || !cpf || !val) return toast("PREENCHA TUDO"); const piloto = db.users.find(u => u.cpf === cpf); 
        
        // STATUS LOGIC
        const status = loggedUser.role === 'ADMIN' ? 'OK' : 'PENDING';

        const newData = { name: piloto.nome, val: val, cat: piloto.cat.split('(')[0].trim(), city: piloto.city || 'PE', evtId: evtId, status: status };
        if(idx) { const oldType = document.getElementById('adm-res-type-edit').value; db[oldType][idx] = newData; toast("ATUALIZADO"); } else { db[type].push(newData); toast("LANÇADO"); }
        if(type === 'tempos') db[type].sort((a,b) => a.val.localeCompare(b.val)); else db[type].sort((a,b) => parseInt(b.val) - parseInt(a.val));
        
        // CLEAR FORM
        document.getElementById('adm-res-val').value=''; 
        document.getElementById('adm-res-search').value='';
        document.getElementById('adm-res-id').value='';

        saveDB(); refreshAdmLists(); cancelEditRes();
    }

    function approveResult(type, index) {
        db[type][index].status = 'OK'; saveDB(); refreshAdmLists(); toast("APROVADO!");
    }

    function iniciarInscricao(evtId, evtName, val) { 
        if(!loggedUser) return toast("FAÇA LOGIN PRIMEIRO"); 
        // Check if already subscribed
        if(loggedUser.inscricoes.some(i => i.id == evtId)) {
             return toast("JÁ INSCRITO");
        }
        currentPayId = { id: parseInt(evtId), name: evtName }; document.getElementById('pix-valor-display').innerText = val ? `R$ ${val}` : "R$ 100,00"; document.getElementById('pix-copy').innerText = "00020126360014BR.GOV.BCB.PIX0114+55819000000005204000053039865802BR5925FPC FEDERACAO PE CICLISMO6006RECIFE62070503***6304E2CA"; document.getElementById('modal-pix').style.display='flex'; 
    }

    // PIX ACTIONS
    function enviarComprovanteWhatsApp() {
        window.open(`https://wa.me/?text=Olá, segue comprovante de inscrição para: ${currentPayId.name} - Piloto: ${loggedUser.nome}`, '_blank');
    }
    
    function confirmarJaPaguei() {
        if(!loggedUser.inscricoes.some(i => i.id == currentPayId.id)) { 
            loggedUser.inscricoes.push({ id: currentPayId.id, status: 'PENDENTE' }); 
            const idx = db.users.findIndex(x => x.cpf === loggedUser.cpf); 
            if(idx > -1) db.users[idx].inscricoes = loggedUser.inscricoes;
            saveDB(); 
            localStorage.setItem(SESS_KEY, JSON.stringify(loggedUser)); 
        }
        fecharModal('modal-pix');
        toast("REGISTRADO! AGUARDE APROVAÇÃO");
        renderContent('calendar');
    }

    function verCartaz(id) { const evt = db.events.find(e => e.id == id); if(evt && evt.img) { document.getElementById('img-poster-view').src = evt.img; document.getElementById('modal-poster').style.display = 'flex'; } }
    function fecharModal(id){ document.getElementById(id).style.display='none'; }
    function delItem(col, idx) { if(confirm("APAGAR?")) { db[col].splice(idx, 1); saveDB(); refreshAdmLists(); } }
    function maskTimeOrPoints(i) { if(document.getElementById('adm-res-type').value === 'ranking') return; let v = i.value.replace(/\D/g, ""); if (v.length > 7) v = v.substring(0, 7); if (v.length >= 2) v = v.substring(0, 2) + ":" + v.substring(2); if (v.length >= 5) v = v.substring(0, 5) + "." + v.substring(5); i.value = v; }
    function copiarPix() { navigator.clipboard.writeText(document.getElementById('pix-copy').innerText); toast("PIX COPIADO!"); }
    function abrirComprovante(nomeEvt) { document.getElementById('tk-nome').innerText = loggedUser.nome; document.getElementById('tk-evento').innerText = nomeEvt; document.getElementById('area-cupom-visual').innerHTML = `<div style="text-align:center;padding:20px;font-family:monospace"><h2>DH-PE TICKET</h2><p>PILOTO: ${loggedUser.nome}</p><p>EVENTO: ${nomeEvt}</p><p>DATA: ${new Date().toLocaleString()}</p></div>`; document.getElementById('modal-ticket').style.display = 'flex'; }
    function imprimirTicket() { document.body.classList.add('printing-cupom'); setTimeout(() => { window.print(); setTimeout(() => document.body.classList.remove('printing-cupom'), 1000); }, 500); }

    function fazerLogin() { 
        try {
            const cpfRaw = document.getElementById('login-cpf').value; const pass = document.getElementById('login-pass').value; const remember = document.getElementById('login-remember').checked;
            if(!cpfRaw || !pass) return toast("PREENCHA TUDO");
            const user = db.users.find(x => cleanCPF(x.cpf) === cleanCPF(cpfRaw) && x.pass === pass);
            if(user) { 
                loggedUser = user; localStorage.setItem(SESS_KEY, JSON.stringify(user)); 
                if(remember) localStorage.setItem(REMEMBER_KEY, cpfRaw + "|" + pass); 
                initApp(); 
                
                if(user.role === 'ADMIN' || user.role === 'ORGANIZER') nav('adm');
                else nav('calendar');

            } else { toast("DADOS INCORRETOS"); }
        } catch(e) { console.log(e); }
    }
    
    function fazerLogout() { localStorage.removeItem(SESS_KEY); window.location.reload(true); }
    function nuclearReset() { if(confirm("RESETAR TUDO?")) { localStorage.clear(); location.reload(); } }
    
    function cadastrar() { 
        const u = { 
            nome: document.getElementById('cad-nome').value.toUpperCase(), 
            cpf: document.getElementById('cad-cpf').value, 
            tel: document.getElementById('cad-tel').value, 
            city: document.getElementById('cad-city').value.toUpperCase(), 
            pass: document.getElementById('cad-pass').value, 
            cat: document.getElementById('cad-cat').value, 
            gender: document.getElementById('cad-gender').value,
            role: 'USER', inscricoes: [] 
        };
        if(!u.nome || !u.cpf || !u.pass) return toast("PREENCHA TUDO");
        if(db.users.some(x => cleanCPF(x.cpf) === cleanCPF(u.cpf))) return toast("CPF JÁ EXISTE");
        db.users.push(u); saveDB(); toast("SUCESSO!"); trocarTela('login');
    }
    
    function reCalcCat() {
        const gender = document.getElementById('cad-gender').value;
        const date = document.getElementById('cad-nasc').value;
        calcCat(date, gender);
    }

    function calcCat(dateStr, gender) {
        if(gender === 'F') {
             document.getElementById('cad-cat').value = "FEMININA";
             return;
        }

        if(!dateStr) return; 
        const age = 2026 - new Date(dateStr).getFullYear(); 
        let cat = "RÍGIDA"; 
        if (age >= 12 && age <= 14) cat = "INFANTO-JUVENIL"; else if (age >= 15 && age <= 16) cat = "JUVENIL"; else if (age >= 17 && age <= 18) cat = "JUNIOR"; else if (age >= 19 && age <= 29) cat = "SUB-30 / ELITE"; else if (age >= 30 && age <= 34) cat = "MASTER A1"; else if (age >= 35 && age <= 39) cat = "MASTER A2"; else if (age >= 40 && age <= 44) cat = "MASTER B1"; else if (age >= 45 && age <= 49) cat = "MASTER B2"; else if (age >= 50 && age <= 54) cat = "MASTER C1"; else if (age >= 55 && age <= 59) cat = "MASTER C2"; else if (age >= 60) cat = "MASTER D";
        document.getElementById('cad-cat').value = cat + ` (${age} ANOS)`;
    }

    function initApp() { 
        if(db.config.logo) document.querySelectorAll('.app-logo-img').forEach(el => el.src = db.config.logo);
        renderStories(); trocarTela('app'); 
        if(loggedUser && (loggedUser.role === 'ADMIN' || loggedUser.role === 'ORGANIZER')) nav('adm');
        else nav('calendar');
    }

    document.getElementById('btn-acessar').addEventListener('click', fazerLogin);

    const savedCreds = localStorage.getItem(REMEMBER_KEY); const session = getUser();
    if(session) { loggedUser = db.users.find(u => cleanCPF(u.cpf) === cleanCPF(session.cpf)); if(loggedUser) initApp(); } 
    else if (savedCreds) { const p = savedCreds.split('|'); document.getElementById('login-cpf').value = p[0]; document.getElementById('login-pass').value = p[1]; document.getElementById('login-remember').checked = true; }
    if(db.config.logo) document.querySelectorAll('.app-logo-img').forEach(el => el.src = db.config.logo);
</script>
</body>
</html>
