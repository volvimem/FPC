<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DH-PE v54.0 (Fixed & Styled)</title>
    
    <link rel="icon" type="image/jpg" href="logo-fp.jpg">
    <link rel="apple-touch-icon" href="logo-fp.jpg">
    <meta name="theme-color" content="#0038a8">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --pe-blue: #0038a8; --pe-yellow: #ffe500; --pe-red: #d50000; --pe-green: #009b3a;
            --bg-body: #f0f2f5; 
            --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        .uppercase-input { text-transform: uppercase; }
        
        body { background: var(--bg-body); min-height: 100vh; padding-bottom: 0; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 600px; margin: 0 auto; position: relative; min-height: 100vh; background: white; }

        /* GERAL */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 6px; background: var(--pe-blue); color: white; font-weight: 700; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); font-size: 14px; text-transform: uppercase; }
        .btn:active { transform: scale(0.97); background: #002a80; }
        .input-group { margin-bottom: 15px; width: 100%; position: relative; }
        .input-group label { font-size: 11px; font-weight: 800; color: var(--pe-blue); margin-left: 2px; display: block; margin-bottom: 5px; }
        .input-wrapper { display: flex; align-items: center; position: relative; }
        input, select { width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; background: white; font-size: 14px; color: #1e293b; font-weight: 600; }
        
        /* OLHO SENHA */
        .pass-eye { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer; z-index: 10; font-size: 18px; }
        .input-wrapper .pass-eye { top: 50%; transform: translateY(-50%); }

        /* TELAS */
        .screen { display: none; flex-direction: column; animation: fade 0.3s; background: var(--bg-body); padding-bottom: 80px; width: 100%; min-height: 100vh; }
        .screen.active { display: flex; }
        
        /* LOGIN */
        #screen-login { height: 100vh; overflow: hidden; position: relative; background: black; padding-bottom: 0; z-index: 2000; }
        .login-bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('image_1.png') no-repeat center center; background-size: cover; z-index: 1; pointer-events: none; }
        .login-overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), rgba(0, 56, 168, 0.9)); z-index: 2; pointer-events: none; }
        .login-content-layer { position: relative; z-index: 100; height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; }
        .login-content-layer h1 { margin: 0 auto 5px auto; color: white; font-size: 32px; text-shadow: 0 3px 10px rgba(0,0,0,0.5); font-weight: 900; letter-spacing: -1px; line-height: 1.1; }
        .login-content-layer p { margin: 5px auto 40px auto; color: rgba(255,255,255,0.9); font-size: 14px; font-weight: bold; letter-spacing: 1px; }
        .login-content-layer .input-group { text-align: left; }
        .login-content-layer input { background: rgba(255, 255, 255, 0.95); border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: #000; }
        .login-content-layer label { color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); font-weight: 900; }
        .login-content-layer .checkbox-wrapper { color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 10px;}
        
        /* HEADER */
        .app-header { background: white; padding: 10px 15px; display: none; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 500; height: 60px; }
        .version-badge { font-size: 10px; font-weight: 900; color: var(--pe-blue); background: #e0e7ff; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--pe-blue); cursor: pointer; }
        .header-logo-text { font-size: 18px; font-weight: 900; color: var(--pe-blue); letter-spacing: -1px; }

        /* LISTAS & CALENDARIO */
        .section-header-area { background: white; padding: 10px 15px; border-bottom: 1px solid #eee; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .section-title { font-size: 14px; color: var(--pe-blue); font-weight: 900; display: flex; align-items: center; gap: 8px; border-left: 5px solid var(--pe-yellow); padding-left: 10px; }
        .filter-row { display: flex; gap: 5px; }
        
        /* DESTAQUE CALENDARIO */
        .calendar-wrapper { padding: 15px; }
        .highlight-event { width: 100%; border: 3px solid var(--pe-yellow); box-shadow: 0 10px 20px rgba(0,0,0,0.2); margin-bottom: 20px; border-radius: 12px; overflow: hidden; background:white; }
        .highlight-event .event-poster-full { width: 100%; height: 200px; object-fit: cover; }
        .highlight-event .event-body { padding: 15px; text-align: center; }
        .mini-events-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .event-card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        .event-top { background: var(--pe-blue); color: white; padding: 5px; text-align: center; font-weight: 700; font-size: 10px; }
        .event-body { padding: 8px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; text-align: center; }
        .event-title { font-size: 11px; font-weight: 800; color: #1e293b; line-height: 1.2; margin-bottom: 5px; }
        .card-poster-thumb { width: 100%; height: 60px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; }
        .event-price { font-size: 10px; font-weight: 900; color: var(--pe-green); background: #dcfce7; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
        .btn-insc { background: var(--pe-green); color: white; border: none; padding: 8px; font-size: 10px; font-weight: 800; cursor: pointer; width: 100%; border-radius: 4px; margin-top: auto; }
        .btn-closed { background: #94a3b8; color: white; border: none; padding: 8px; font-size: 10px; font-weight: 800; cursor: not-allowed; width: 100%; border-radius: 4px; margin-top: auto; }
        .btn-points { background: #64748b; color: white; border: none; padding: 6px; font-size: 9px; font-weight: 800; cursor: pointer; width: 100%; border-radius: 4px; margin-top: 5px; }
        .btn-share { background: #E1306C; color: white; border: none; padding: 8px; font-size: 10px; font-weight: 800; cursor: pointer; width: 100%; border-radius: 4px; margin-top: auto; }
        
        /* 1. VISUAL DATA ENCERRAMENTO */
        .event-close-date { font-size: 10px; font-weight: 800; color: #d50000; margin-top: 5px; display:block; }

        /* 3. NOVOS ÍCONES/BADGES (ATUALIZADO) */
        .badge-box { display: flex; justify-content: center; gap: 5px; margin: 5px 0; }
        .badge-pe { background: var(--pe-blue); color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 900; }
        .badge-cbc { background: var(--pe-yellow); color: var(--pe-blue); padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 900; }

        /* RANKING */
        .rank-list-container { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; margin: 0 10px; }
        .rank-row { display: flex; align-items: center; padding: 10px 8px; border-bottom: 1px solid #f1f5f9; font-size: 11px; }
        .rank-row:nth-child(even) { background: #f8fafc; }
        .rank-pos { width: 25px; font-weight: 900; color: #64748b; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .rank-name { flex: 1; font-weight: 700; color: #334155; display: flex; flex-direction: column; padding-left: 5px; }
        .rank-cat { font-size: 9px; color: #666; margin-top: 2px; }
        .rank-val { font-family: monospace; font-weight: 900; color: var(--pe-blue); background: #e0e7ff; padding: 4px 8px; border-radius: 4px; font-size: 11px; }

        /* ADMIN */
        .admin-dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .adm-dash-btn { background: white; border-radius: 8px; padding: 20px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; text-align: center; border: 1px solid #eee; }
        .adm-dash-btn i { font-size: 24px; color: var(--pe-blue); }
        .admin-item-row { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 8px; border-bottom: 1px solid #e2e8f0; font-size: 10px; }
        .admin-actions { display: flex; gap: 5px; }
        .btn-mini-adm { padding: 4px 8px; border-radius: 4px; border:none; color:white; font-size: 10px; cursor: pointer; }
        .btn-red { background: #ef4444; } .btn-blue { background: #3b82f6; } .btn-green { background: var(--pe-green); }
        .perm-list { display: flex; flex-direction: column; gap: 5px; max-height: 100px; overflow-y: auto; background: #f9f9f9; padding: 5px; border: 1px solid #eee; margin-top: 5px; }
        .pending-tag { font-size: 8px; background: orange; color: white; padding: 2px 4px; border-radius: 2px; margin-left: 5px; }

        /* SEARCHABLE LIST */
        .smart-search-container { position: relative; z-index: 500; }
        .smart-list { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; max-height: 250px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .smart-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 11px; cursor: pointer; display:flex; justify-content:space-between; align-items:center; }
        .smart-item:hover { background: #f0f9ff; }
        .smart-actions { display:flex; gap:5px; }

        /* TABLE */
        .fin-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px; }
        .fin-table th { background: var(--pe-blue); color: white; padding: 8px; text-align: left; }
        .fin-table td { border-bottom: 1px solid #eee; padding: 8px; background: white; }
        .status-pend { color: #d97706; font-weight: 800; background: #fef3c7; padding: 2px 6px; border-radius: 4px; cursor:pointer; }
        .status-ok { color: #166534; font-weight: 800; background: #dcfce7; padding: 2px 6px; border-radius: 4px; cursor:pointer; }
        .stats-box { display: flex; gap: 10px; margin: 10px 0; background: #f0f9ff; padding: 10px; border-radius: 6px; justify-content: space-around; font-size: 10px; font-weight: bold; color: var(--pe-blue); border: 1px solid #bae6fd; }
        .wpp-big { font-size: 24px; color: #25D366; vertical-align: middle; margin-left: 5px; }

        /* SHARE CARD */
        .share-card { background: linear-gradient(180deg, #0038a8 60%, #ffffff 60%); padding: 0; border-radius: 15px; color: white; text-align: center; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); overflow: hidden; position: relative; }
        .share-header-rainbow { height: 15px; width: 100%; background: linear-gradient(90deg, #d50000 33%, #ffe500 33%, #ffe500 66%, #009b3a 66%); }
        .share-content-box { padding: 30px 20px; }
        .share-card h2 { font-size: 32px; margin: 0 0 5px 0; font-weight: 900; text-shadow: 2px 2px 0px #000; color: #ffe500; letter-spacing: -1px; }
        .share-card p.sub { font-size: 12px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .share-piloto { font-size: 20px; font-weight: 900; margin: 15px 0; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .share-event { font-size: 12px; font-weight: bold; color: #0038a8; margin-top: 30px; text-transform: uppercase; }
        .share-badge { background: #009b3a; color: white; padding: 8px 20px; border-radius: 20px; font-weight: 900; font-size: 12px; margin-top: 15px; display: inline-block; border: 2px solid #ffe500; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* BARRA INFERIOR */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; display: none; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 9000; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .bar-item { flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; font-weight: 700; cursor: pointer; background: white; }
        .bar-item i { font-size: 20px; margin-bottom: 4px; pointer-events: none; }
        .bar-item.active { color: var(--pe-blue); background: #f0f9ff; border-top: 3px solid var(--pe-red); }

        /* UTILS */
        .btn-icon { background: none; border: none; font-size: 16px; color: #666; cursor: pointer; padding: 5px; }
        .search-area { display: none; margin-top: 5px; animation: fade 0.3s; }
        .login-options { display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 10px; width: 100%; padding: 0 5px; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        @keyframes fade { from { opacity:0; } to { opacity:1; } }
        
        /* IMPRESSÃO */
        @media print { 
            body * { visibility: hidden; } 
            #printable-area, #printable-area * { visibility: visible; } 
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background: white !important; color: black !important; display: block !important; z-index: 999999; }
            .print-cat-block { margin-bottom: 20px; page-break-inside: avoid; border: 1px solid #000; }
            .print-cat-title { background: #333; color: white !important; font-weight: bold; padding: 8px; text-align: center; font-size: 14px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .print-table { width: 100%; border-collapse: collapse; font-size: 12px; font-family: 'Arial', sans-serif; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; }
            .print-table th { background: #eee !important; -webkit-print-color-adjust: exact; font-weight: 800; text-transform: uppercase; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
            .print-header h1 { font-size: 24px; margin: 0; font-weight: 900; text-transform: uppercase; }
            .print-header p { font-size: 14px; margin: 5px 0 0 0; }
            .manual-cell { width: 120px; height: 30px; } 
            .termo-container { font-family: 'Arial', sans-serif; line-height: 1.6; color: #000; text-align: justify; padding: 20px; border: 2px solid #000; }
            .termo-title { text-align: center; font-weight: 900; text-transform: uppercase; margin-bottom: 20px; border-bottom: 1px solid #000; padding-bottom: 10px; font-size: 18px; }
            .termo-body { font-size: 12px; margin-bottom: 20px; }
            .termo-field { margin-bottom: 5px; font-weight: bold; }
            .termo-sign { margin-top: 50px; border-top: 1px solid #000; width: 60%; margin-left: auto; margin-right: auto; text-align: center; padding-top: 5px; }
            .termo-obs { font-size: 10px; font-style: italic; margin-top: 20px; text-align: center; }
        }

        /* MODAIS */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 200000; display:none; flex-direction:column; align-items:center; justify-content:center; }
        .modal-box { background: white; width: 90%; max-width: 380px; padding: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-top: 5px solid var(--pe-yellow); border-radius: 8px; max-height: 90vh; overflow-y: auto; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--pe-blue); color: white; padding: 8px 16px; font-size: 11px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300000; font-weight: 600; border-bottom: 3px solid var(--pe-yellow); }
        .toast.show { opacity: 1; top: 60px; }
    </style>
</head>
<body>

<div class="toast" id="toast">MSG</div>
<div id="area-cupom-visual" style="display:none"></div>
<div id="printable-area" style="display:none; padding:20px;"></div>

<div class="modal-overlay" id="modal-share">
    <div class="modal-box" style="background:transparent; box-shadow:none; border:none; width:auto">
        <div class="share-card">
            <div class="share-header-rainbow"></div>
            <div class="share-content-box">
                <h2>EU VOU!</h2>
                <p class="sub">CAMPEONATO PERNAMBUCANO DE DOWNHILL</p>
                <div id="share-piloto-name" class="share-piloto">NOME PILOTO</div>
                <div class="share-badge">INSCRIÇÃO CONFIRMADA</div>
                <div id="share-event-name" class="share-event">NOME DO EVENTO</div>
            </div>
        </div>
        <p style="color:white; font-size:11px; margin-bottom:10px">TIRE UM PRINT E POSTE NO INSTAGRAM!</p>
        <button class="btn" style="background:#E1306C; margin-bottom:5px" onclick="shareNative()">COMPARTILHAR <i class="fas fa-share-alt"></i></button>
        <button class="btn" style="background:white; color:#333" onclick="fecharModal('modal-share')">FECHAR</button>
    </div>
</div>

<div class="modal-overlay" id="modal-points">
    <div class="modal-box">
        <h3 style="color:var(--pe-blue)">TABELA DE PONTOS</h3>
        <p style="font-size:11px; color:#666" id="modal-points-subtitle">...</p>
        <div id="public-points-list" style="margin-top:10px; text-align:left;"></div>
        <button class="btn" style="background:#ddd; color:#333; margin-top:15px" onclick="fecharModal('modal-points')">FECHAR</button>
    </div>
</div>

<div class="modal-overlay" id="modal-print-options"><div class="modal-box"><h3 style="color:var(--pe-blue)">IMPRIMIR PLANILHA</h3><button class="btn" onclick="generatePrint('ALL')">TODAS CATEGORIAS (GERAL)</button><div style="margin:10px 0; border-top:1px solid #eee; padding-top:10px; font-size:10px; font-weight:bold; color:#666">OU POR CATEGORIA:</div><div id="print-cat-list" style="max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:5px;"></div><button class="btn" style="background:#ddd; color:#333; margin-top:10px" onclick="fecharModal('modal-print-options')">CANCELAR</button></div></div>
<div class="modal-overlay" id="modal-edit-user"><div class="modal-box"><h3 style="color:var(--pe-blue)">EDITAR ATLETA</h3><input type="hidden" id="edit-user-original-cpf"><div class="input-group"><label>NOME</label><input id="edit-user-name" class="uppercase-input"></div><div class="input-group"><label>CIDADE</label><input id="edit-user-city" class="uppercase-input"></div><div class="input-group"><label>CATEGORIA</label><input id="edit-user-cat"></div><div class="input-group"><label>GÊNERO (M/F)</label><input id="edit-user-gender" maxlength="1" class="uppercase-input"></div><button class="btn" onclick="saveUserEdit()">SALVAR ALTERAÇÕES</button><button class="btn" style="background:#ddd; color:#333; margin-top:5px" onclick="fecharModal('modal-edit-user')">CANCELAR</button></div></div>
<div class="modal-overlay" id="modal-poster"><div class="modal-box" style="padding:0; background:black; border:none; width:95%; max-width:400px"><div style="position:relative"><img id="img-poster-view" style="width:100%; display:block"><button onclick="fecharModal('modal-poster')" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; padding:10px; border-radius:50%; cursor:pointer"><i class="fas fa-times"></i></button></div></div></div>
<div class="modal-overlay" id="modal-ticket"><div class="modal-box"><h2 style="color:var(--pe-blue); margin-bottom:5px">TICKET CONFIRMADO</h2><div style="width:50px; height:5px; background:var(--pe-grad); margin:0 auto 15px auto"></div><div style="text-align:left; border:1px dashed #ccc; padding:15px; margin-bottom:15px; background:#f9f9f9"><b style="font-size:10px; color:#999">EVENTO:</b><br><span style="font-size:14px; color:var(--pe-blue); font-weight:900" id="tk-evento">...</span><br><br><b style="font-size:10px; color:#999">PILOTO:</b><br><span style="font-size:12px; color:#333; font-weight:bold" id="tk-nome">...</span></div><button class="btn" onclick="openShareModal(document.getElementById('tk-evento').innerText)"><i class="fab fa-instagram"></i> COMPARTILHAR</button><button class="btn" style="margin-top:5px" onclick="imprimirTicket()"><i class="fas fa-print"></i> IMPRIMIR TICKET</button><button class="btn" style="margin-top:5px; background:#333" onclick="gerarTermo(currentPayId.id)"><i class="fas fa-file-contract"></i> IMPRIMIR TERMO</button><button class="btn" onclick="fecharModal('modal-ticket')" style="background:#ddd; color:#333; margin-top:5px">FECHAR</button></div></div>
<div class="modal-overlay" id="modal-pix"><div class="modal-box"><h3 style="color:var(--pe-green)"><i class="fas fa-qrcode"></i> PAGAMENTO</h3><p style="font-size:12px; color:#666; margin:5px 0">VALOR: <b style="color:var(--pe-blue)" id="pix-valor-display">R$ 0,00</b></p><div style="background:#f0fdf4; border:1px dashed var(--pe-green); padding:10px; margin:10px 0; font-size:10px; word-break:break-all; font-weight:bold" id="pix-copy">...</div><button class="btn" style="margin-top:0; background:#64748b" onclick="copiarPix()"><i class="far fa-copy"></i> COPIAR CÓDIGO</button><hr style="border:0; border-top:1px solid #eee; margin:15px 0"><button class="btn" style="background:#25D366" onclick="enviarComprovanteWhatsApp()"><i class="fab fa-whatsapp"></i> ENVIAR COMPROVANTE</button><button class="btn" style="background:var(--pe-blue); margin-top:5px" onclick="confirmarJaPaguei()"><i class="fas fa-check-circle"></i> JÁ PAGUEI (REGISTRAR)</button><button class="btn" style="background:#ddd; color:#333; margin-top:5px" onclick="fecharModal('modal-pix')">CANCELAR</button></div></div>
<div class="modal-overlay" id="modal-info"><div class="modal-box"><h3 id="info-title" style="color:var(--pe-blue)">INFO</h3><p id="info-text" style="font-size:13px; color:#555; margin:15px 0; text-align:left">...</p><button class="btn" onclick="fecharModal('modal-info')" style="background:#ddd; color:#333">FECHAR</button></div></div>

<div class="app-container">
    
    <div id="screen-login" class="screen active">
        <div class="login-bg-layer"></div><div class="login-overlay-layer"></div>
        <div class="login-content-layer">
            <h1>CAMPEONATO PERNAMBUCANO DE DOWNHILL</h1><p>TEMPORADA 2026</p>
            <div class="input-group"><label>CPF</label><div class="input-wrapper"><input type="tel" id="login-cpf" placeholder="000.000.000-00" oninput="mascaraCPF(this)" maxlength="14"></div></div>
            <div class="input-group"><label>SENHA</label><div class="input-wrapper"><input type="password" id="login-pass" placeholder="••••"><i class="fas fa-eye pass-eye" onclick="togglePass('login-pass')"></i></div></div>
            <div class="checkbox-wrapper"><input type="checkbox" id="login-remember"> MANTER CONECTADO</div>
            <button id="btn-acessar" class="btn" style="background:var(--pe-yellow); color:var(--pe-blue); font-weight:900;" onclick="fazerLogin()">ACESSAR CONTA</button>
            <button class="btn" onclick="trocarTela('cadastro')" style="background:rgba(255,255,255,0.2); color:white; margin-top:10px; border:1px solid rgba(255,255,255,0.3)">CRIAR CONTA</button>
        </div>
    </div>

    <div id="screen-cadastro" class="screen">
        <div style="padding:15px; background:white; border-bottom:1px solid #eee; display:flex; align-items:center; gap:10px"><i class="fas fa-arrow-left" onclick="trocarTela('login')" style="font-size:18px; color:#333; cursor:pointer"></i><h2 style="color:var(--pe-blue); margin:0; font-size:16px">CADASTRO</h2></div>
        <div style="width:100%; padding:20px; background:white;">
            <div class="input-group"><label>NOME COMPLETO</label><div class="input-wrapper"><input id="cad-nome" class="uppercase-input"></div></div>
            <div class="input-group"><label>CPF (COM PONTOS)</label><div class="input-wrapper"><input type="tel" id="cad-cpf" oninput="mascaraCPF(this)" maxlength="14"></div></div>
            <div class="input-group"><label>WHATSAPP</label><div class="input-wrapper"><input type="tel" id="cad-tel" oninput="mascaraTel(this)" maxlength="15"></div></div>
            <div class="input-group"><label>CIDADE</label><div class="input-wrapper"><input id="cad-city" class="uppercase-input"></div></div>
            <div class="input-group"><label>GÊNERO</label><select id="cad-gender" onchange="reCalcCat()"><option value="M">MASCULINO</option><option value="F">FEMININO</option></select></div>
            <div class="input-group"><label>DATA NASC.</label><div class="input-wrapper"><input type="date" id="cad-nasc" onchange="reCalcCat()"></div></div>
            <div class="input-group"><label>CATEGORIA</label><div class="input-wrapper"><input id="cad-cat" readonly style="background:#eef2ff; color:#132047; font-weight:900"></div></div>
            <div class="input-group"><label>SENHA</label><div class="input-wrapper"><input type="password" id="cad-pass"><i class="fas fa-eye pass-eye" onclick="togglePass('cad-pass')"></i></div></div>
            
            <div class="input-group" style="margin-top:10px; border:1px dashed #ccc; padding:10px; background:#f9f9f9">
                <label style="color:red">SELFIE (OBRIGATÓRIO)</label>
                <input type="file" id="cad-selfie" accept="image/*" capture="user">
                <p style="font-size:9px; color:#666; margin-top:5px">Tire uma foto do seu rosto para segurança.</p>
            </div>

            <button class="btn" onclick="cadastrar()">CONFIRMAR</button>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <div id="main-app-header" class="app-header">
            <div class="header-logo-text">DH-PE</div>
            <div class="version-badge" onclick="appRefresh()">v53.0</div>
        </div>
        
        <div id="cont-calendar" class="c-sec active">
            <div class="section-header-area">
                 <div class="section-title-row" style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="section-title">CALENDÁRIO 2026</div>
                 </div>
            </div>
            <div class="calendar-wrapper">
                <div id="calendar-highlight"></div>
                <div id="calendar-others" class="mini-events-grid"></div>
            </div>
        </div>

        <div id="cont-tempos" class="c-sec" style="display:none">
            <div class="section-header-area">
                <div class="section-title-row">
                    <div class="section-title">TEMPOS</div>
                    <button class="btn-icon" onclick="toggleSearch('tempos')"><i class="fas fa-search"></i></button>
                </div>
                <div class="filter-row">
                    <select id="filter-evt-tempos" onchange="renderContent('tempos')" style="flex:1"><option value="ALL">TODAS ETAPAS</option></select>
                    <select id="filter-cat-tempos" onchange="renderContent('tempos')" style="flex:1"></select>
                </div>
                <div id="search-box-tempos" class="search-area">
                    <input type="text" id="search-input-tempos" placeholder="Buscar..." oninput="renderContent('tempos')">
                </div>
            </div>
            <div class="rank-list-container" id="list-tempos"></div>
        </div>

        <div id="cont-ranking" class="c-sec" style="display:none">
            <div class="section-header-area">
                <div class="section-title-row">
                    <div class="section-title">RANKING</div>
                    <button class="btn-icon" onclick="toggleSearch('ranking')"><i class="fas fa-search"></i></button>
                </div>
                <div class="filter-row">
                    <select id="filter-evt-ranking" onchange="renderContent('ranking')" style="flex:1"><option value="ALL">GERAL (SOMA)</option></select>
                    <select id="filter-cat-ranking" onchange="renderContent('ranking')" style="flex:1"></select>
                </div>
                <div id="search-box-ranking" class="search-area">
                    <input type="text" id="search-input-ranking" placeholder="Buscar..." oninput="renderContent('ranking')">
                </div>
            </div>
            <div class="rank-list-container" id="list-ranking"></div>
        </div>

        <div id="cont-adm" class="c-sec" style="display:none; padding:10px">
            <div class="section-title" style="color:var(--pe-red)">PAINEL ADMIN</div>
            <div id="adm-login-box">
                <div class="input-group"><label>SENHA DE SEGURANÇA</label><div class="input-wrapper"><input type="password" id="adm-pass-check"><i class="fas fa-eye pass-eye" onclick="togglePass('adm-pass-check')"></i></div></div>
                <button class="btn" style="background:var(--pe-red)" onclick="checkAdmPass()">LIBERAR</button>
            </div>
            
            <div id="adm-panel-real" style="display:none">
                <div class="admin-dashboard-grid" id="adm-menu">
                    <div id="btn-adm-events" class="adm-dash-btn" onclick="openAdmSection('events')"><i class="far fa-calendar-plus"></i><span>GERENCIAR EVENTOS</span></div>
                    <div class="adm-dash-btn" onclick="openAdmSection('results')"><i class="fas fa-stopwatch"></i><span>LANÇAR RESULTADOS</span></div>
                    <div class="adm-dash-btn" id="btn-menu-org" onclick="openAdmSection('organizer')"><i class="fas fa-users-cog"></i><span>EQUIPE</span></div>
                    <div class="adm-dash-btn" onclick="openAdmSection('financial')"><i class="fas fa-file-invoice-dollar"></i><span>STATUS DE ATLETAS</span></div>
                    <div class="adm-dash-btn" onclick="openAdmSection('users-edit')"><i class="fas fa-user-edit"></i><span>ATLETAS</span></div>
                </div>

                <div id="adm-sec-events" style="display:none">
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-blue); font-size:12px">CRIAR/EDITAR EVENTO</b>
                        <input type="hidden" id="adm-evt-id-edit">
                        <input id="adm-evt-t" placeholder="NOME DO EVENTO" class="uppercase-input" style="margin-top:5px">
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px">
                            <div>
                                <label style="font-size:9px; font-weight:bold">MÊS</label>
                                <select id="adm-evt-month"><option value="JAN">JAN</option><option value="FEV">FEV</option><option value="MAR">MAR</option><option value="ABR">ABR</option><option value="MAI">MAI</option><option value="JUN">JUN</option><option value="JUL">JUL</option><option value="AGO">AGO</option><option value="SET">SET</option><option value="OUT">OUT</option><option value="NOV">NOV</option><option value="DEZ">DEZ</option></select>
                            </div>
                            <div>
                                <label style="font-size:9px; font-weight:bold">DIAS</label>
                                <input id="adm-evt-d" placeholder="00/00" oninput="mascaraData(this)" maxlength="5">
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px">
                            <input id="adm-evt-c" placeholder="CIDADE" class="uppercase-input">
                            <input id="adm-evt-v" placeholder="VALOR (R$)" type="tel">
                        </div>

                        <div style="margin-top:5px; padding:5px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:4px">
                            <label style="font-size:9px; font-weight:bold">DATA LIMITE INSCRIÇÃO</label>
                            <input type="date" id="adm-evt-close-date">
                            <div style="margin-top:5px">
                                <label style="font-size:9px; font-weight:bold">STATUS ATUAL:</label>
                                <select id="adm-evt-status"><option value="OPEN">ABERTO</option><option value="CLOSED">ENCERRADO</option></select>
                            </div>
                        </div>

                        <div style="margin-top:5px"><label style="font-size:9px; font-weight:bold; color:#666">CARTAZ</label><input type="file" id="adm-evt-img" accept="image/*"></div>
                        <div style="display:flex; gap:10px; margin:10px 0; font-size:10px; font-weight:bold"><label><input type="checkbox" id="adm-evt-cb-pe" checked> ESTADUAL</label><label><input type="checkbox" id="adm-evt-cb-cbc"> CBC</label></div>
                        
                        <div style="margin-top:10px; border-top:2px dashed #eee; padding-top:10px;">
                            <b style="font-size:10px; color:var(--pe-blue)">PONTUAÇÃO (1º ao 20º)</b>
                            <div id="evt-points-grid" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:3px; margin-top:5px"></div>
                        </div>
                        
                        <button class="btn" id="btn-save-event" style="padding:8px; margin:15px 0 0 0" onclick="addEvent()">CADASTRAR EVENTO</button>
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:5px"><p style="font-size:9px; color:#999">LISTA</p><div id="adm-list-events"></div></div>
                    </div>
                    <button class="btn" style="background:#999; margin-top:20px" onclick="backToAdmMenu()">VOLTAR AO MENU</button>
                </div>

                <div id="adm-sec-results" style="display:none">
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-green); font-size:12px">LANÇAR RESULTADOS</b>
                        <input type="hidden" id="adm-res-index-edit">
                        <input type="hidden" id="adm-res-type-edit">
                        <select id="adm-res-evt" style="margin-top:5px; font-size:10px; font-weight:bold; color:var(--pe-blue)" onchange="saveAdmState()"><option value="">SELECIONE O EVENTO...</option></select>
                        <div style="display:flex; gap:5px; margin-top:5px">
                            <select id="adm-res-type" style="width:auto" onchange="saveAdmState()"><option value="tempos">TEMPO</option><option value="ranking">RANKING</option></select>
                            <select id="adm-res-id" style="flex:1; font-size:10px" onchange="saveAdmState()"><option value="">⬇ BUSQUE ABAIXO ⬇</option></select>
                        </div>
                        <div class="smart-search-container" style="margin-top:5px; z-index:1000">
                            <input type="text" id="adm-res-search" placeholder="DIGITE NOME, CPF OU CIDADE..." oninput="filterPilots('res')" autocomplete="off">
                            <div id="adm-res-list" class="smart-list"></div>
                        </div>
                        
                        <div style="display:flex; gap:5px; margin-top:5px; position:relative; z-index:1;">
                            <input id="adm-res-num" placeholder="Nº PLACA" type="tel" style="width:120px; text-align:center;" oninput="saveAdmState()">
                            <input id="adm-res-val" placeholder="00:00.000 / PTS" oninput="maskTimeOrPoints(this, event); saveAdmState()" style="flex:1">
                        </div>

                        <button class="btn" id="btn-save-res" style="width:100%; margin-top:15px; background:var(--pe-green)" onclick="addResult()">LANÇAR</button>
                        <button class="btn" id="btn-cancel-res" style="width:100%; margin-top:5px; background:#999; display:none" onclick="cancelEditRes()">CANCELAR</button>
                        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:5px"><p style="font-size:9px; color:#999">ÚLTIMOS LANÇAMENTOS</p><div id="adm-list-results" style="max-height:150px; overflow-y:auto"></div></div>
                    </div>
                     <button class="btn" style="background:#999; margin-top:20px" onclick="backToAdmMenu()">VOLTAR AO MENU</button>
                </div>

                <div id="adm-sec-organizer" style="display:none">
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-blue); font-size:12px">CADASTRAR ORGANIZADOR</b>
                        <div class="smart-search-container" style="margin-top:20px; margin-bottom:10px; border-top:1px solid #eee; padding-top:10px">
                             <label style="font-size:9px; font-weight:bold; color:#666">BUSCAR ATLETA PARA PROMOVER:</label>
                            <input type="text" id="adm-org-search" placeholder="DIGITE NOME DO ATLETA..." oninput="filterPilots('org')" autocomplete="off">
                            <div id="adm-org-list-search" class="smart-list"></div>
                            <input type="hidden" id="adm-org-selected-cpf">
                        </div>
                        <div id="org-perms-area" style="display:none">
                            <p style="font-size:10px;font-weight:bold;margin:10px 0 5px 0">PERMISSÃO DE ETAPAS:</p>
                            <div id="org-events-list" class="perm-list"></div>
                            <button class="btn" style="background:#666; margin-top:10px" onclick="promoteToOrganizer()">PROMOVER SELECIONADO</button>
                        </div>
                        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:5px">
                            <b style="font-size:10px; color:#666">LISTA DE ORGANIZADORES</b>
                            <div id="adm-list-orgs" style="max-height:150px; overflow-y:auto"></div>
                        </div>
                    </div>
                     <button class="btn" style="background:#999; margin-top:20px" onclick="backToAdmMenu()">VOLTAR AO MENU</button>
                </div>

                <div id="adm-sec-users-edit" style="display:none">
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                            <b style="color:var(--pe-blue); font-size:12px">ATLETAS (EDITAR)</b>
                            <button class="btn-icon" onclick="toggleUserSearch()"><i class="fas fa-search"></i></button>
                        </div>
                         <div id="adm-user-search-wrapper" class="smart-search-container" style="display:none; margin-top:10px; margin-bottom:10px;">
                            <input type="text" id="adm-edit-user-search" placeholder="BUSCAR POR NOME, CPF OU CIDADE..." oninput="filterPilots('edit-user')" autocomplete="off">
                            <div id="adm-edit-user-list" class="smart-list" style="display:block; position:static; border:1px solid #eee; border-top:none"></div>
                        </div>
                        <p style="font-size:10px; color:#999; text-align:center">Clique na lupa para buscar atletas</p>
                    </div>
                     <button class="btn" style="background:#999; margin-top:20px" onclick="backToAdmMenu()">VOLTAR AO MENU</button>
                </div>

                <div id="adm-sec-financial" style="display:none">
                    <div style="background:white; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <b style="color:var(--pe-blue); font-size:12px">STATUS DE ATLETAS</b>
                        <select id="fin-evt-select" style="margin:10px 0" onchange="renderInscriptions()"><option value="">SELECIONE O EVENTO...</option></select>
                        <div class="stats-box">
                            <span id="stat-total">Total: 0</span>
                            <span id="stat-paid" style="color:green">Pagos: 0</span>
                            <span id="stat-money">R$ 0,00</span>
                        </div>
                        <div style="display:flex;gap:5px;margin-bottom:5px">
                            <button class="btn-mini-adm" style="background:#ccc;color:#333;flex:1" onclick="filterFinList('ALL')">GERAL</button>
                            <button class="btn-mini-adm btn-green" style="flex:1" onclick="filterFinList('CONFIRMADO')">PAGOS</button>
                            <button class="btn-mini-adm" style="background:orange;flex:1" onclick="filterFinList('PENDENTE')">PEND</button>
                        </div>
                        <div id="fin-list-container"></div>
                        <button class="btn" style="margin-top:10px; background:#333" onclick="openPrintOptions()"><i class="fas fa-print"></i> IMPRIMIR PLANILHA</button>
                    </div>
                     <button class="btn" style="background:#999; margin-top:20px" onclick="backToAdmMenu()">VOLTAR AO MENU</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar" id="main-nav-bar">
        <div class="bar-item active" id="btn-calendar" onclick="nav('calendar')"><i class="far fa-calendar-alt"></i><span>CAL</span></div>
        <div class="bar-item" id="btn-tempos" onclick="nav('tempos')"><i class="fas fa-stopwatch"></i><span>TEMPO</span></div>
        <div class="bar-item" id="btn-ranking" onclick="nav('ranking')"><i class="fas fa-trophy"></i><span>RANK</span></div>
        <div class="bar-item" id="btn-adm" onclick="tryOpenAdmin()"><i class="fas fa-user-shield"></i><span>ADM</span></div>
        <div class="bar-item" onclick="fazerLogout()"><i class="fas fa-sign-out-alt"></i><span>SAIR</span></div>
    </div>

</div>

<script>
    window.onerror = function(msg, url, line) { alert("ERRO: " + msg + "\nLinha: " + line); return true; };
    function appRefresh() { window.location.reload(true); }

    const DB_KEY = 'dhpe_v53_0_db'; const SESS_KEY = 'dhpe_sess_v53_0'; const REMEMBER_KEY = 'dhpe_remember_token_v530';
    const ADMIN_CPF = "083.276.324-18"; const ADMIN_PASS = "0800"; 
    const LAST_TAB_KEY = 'dhpe_last_tab_v53';
    const LAST_ADM_KEY = 'dhpe_last_adm_v53';
    const FORM_STATE_KEY = 'dhpe_form_state_v53';

    const usersList = [{ nome: "ABRAAO EVERTON LOPES DE ARAUJO", cpf: ADMIN_CPF, pass: ADMIN_PASS, cat: "ORGANIZAÇÃO", tel: "81900000000", city: "RECIFE", gender:"M", role: "ADMIN", allowedEvts: [], inscricoes: [], selfie: null }];
    
    const DEFAULT_POINTS = [50, 45, 40, 35, 30, 26, 24, 22, 20, 18, 16, 14, 12, 10, 8, 6, 4, 3, 2, 1];
    const DEFAULT_DB = {
        users: usersList,
        events: [{ id:1, d:'25/26', m:'ABR', city:'OURICURI-PE', t:'1ª ETAPA ESTADUAL', val: "100,00", est:true, cbc:false, open:true, img:null, points: [...DEFAULT_POINTS], status: 'OPEN', closeDate: '' }],
        tempos: [], ranking: [],
        config: { logo: 'logo-fp.jpg' }
    };

    function cleanCPF(v) { return v ? v.replace(/\D/g, "") : ""; } 
    function mascaraCPF(i) { let v = i.value.replace(/\D/g, "").substring(0, 11); i.value = v.replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d{1,2})$/, "$1-$2"); }
    function mascaraTel(i) { let v = i.value.replace(/\D/g, "").substring(0, 11); v = v.replace(/^(\d{2})(\d)/g, "($1) $2"); v = v.replace(/(\d)(\d{4})$/, "$1-$2"); i.value = v; }
    function mascaraData(i) { let v = i.value.replace(/\D/g,""); if(v.length > 4) v = v.substring(0,4); if(v.length > 2) v = v.substring(0,2) + '/' + v.substring(2); i.value = v; }
    function togglePass(id) { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; }

    let db; try { db = JSON.parse(localStorage.getItem(DB_KEY)); if(!db) throw new Error("DB empty"); } catch(e) { db = DEFAULT_DB; saveDB(); }
    const adminIndex = db.users.findIndex(u => cleanCPF(u.cpf) === cleanCPF(ADMIN_CPF));
    if(adminIndex >= 0) { db.users[adminIndex].role = "ADMIN"; db.users[adminIndex].pass = ADMIN_PASS; } else { db.users.push(DEFAULT_DB.users[0]); }
    
    // Migration: Add status/closeDate if missing
    db.events.forEach(e => { if(!e.points || e.points.length < 20) e.points = [...DEFAULT_POINTS]; if(!e.status) e.status = 'OPEN'; });
    saveDB();

    let currentTab = 'calendar'; let currentAdmSection = null; let loggedUser = null; let currentPayId = null;

    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function getUser() { return JSON.parse(localStorage.getItem(SESS_KEY)); }
    function toast(m) { const t=document.getElementById('toast'); t.innerText=m.toUpperCase(); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    
    // 3. COMPRESSAO IMAGEM
    function compressImage(file, maxWidth, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ratio = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * ratio;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                callback(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    }

    function trocarTela(id) { 
        document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')); 
        document.getElementById('screen-'+id).classList.add('active'); 
        if(id === 'app') {
            document.getElementById('main-nav-bar').style.display = 'flex';
            document.getElementById('main-app-header').style.display = 'flex';
        } else {
            document.getElementById('main-nav-bar').style.display = 'none';
            document.getElementById('main-app-header').style.display = 'none';
        }
    }

    function toggleSearch(id) { const el = document.getElementById('search-box-'+id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
    
    function toggleUserSearch() { 
        const el = document.getElementById('adm-user-search-wrapper'); 
        const isHidden = el.style.display === 'none';
        el.style.display = isHidden ? 'block' : 'none';
        if(!isHidden) { 
            document.getElementById('adm-edit-user-search').value = '';
            document.getElementById('adm-edit-user-list').style.display = 'none';
        } else {
            document.getElementById('adm-edit-user-search').value = '';
            filterPilots('edit-user', true);
        }
    }

    function nav(t) {
        if(t === 'adm' && (!loggedUser || (loggedUser.role !== 'ADMIN' && loggedUser.role !== 'ORGANIZER'))) return toast("ACESSO NEGADO");
        currentTab = t;
        localStorage.setItem(LAST_TAB_KEY, t);

        document.querySelectorAll('.bar-item').forEach(b => b.classList.remove('active'));
        if(document.getElementById('btn-'+t)) document.getElementById('btn-'+t).classList.add('active');
        document.querySelectorAll('.c-sec').forEach(e => e.style.display='none');
        document.getElementById('cont-'+t).style.display='block';
        
        if(t === 'adm') { 
            if(loggedUser.role === 'ADMIN' || loggedUser.role === 'ORGANIZER') { 
                document.getElementById('adm-login-box').style.display='none'; 
                document.getElementById('adm-panel-real').style.display='block'; 
                
                if(loggedUser.role !== 'ADMIN') document.getElementById('btn-adm-events').style.display = 'none';
                else document.getElementById('btn-adm-events').style.display = 'flex';

                const lastAdm = localStorage.getItem(LAST_ADM_KEY);
                if(lastAdm) openAdmSection(lastAdm);
                else backToAdmMenu(); 
            } else { 
                document.getElementById('adm-pass-check').value = ''; 
                document.getElementById('adm-panel-real').style.display = 'none'; 
                document.getElementById('adm-login-box').style.display = 'block'; 
            }
        } else { 
            localStorage.removeItem(LAST_ADM_KEY); 
            renderContent(t); 
        }
    }
    
    function tryOpenAdmin() { if(loggedUser && (loggedUser.role === 'ADMIN' || loggedUser.role === 'ORGANIZER')) nav('adm'); else alert("Apenas Organizadores."); }

    function renderContent(t) {
        if(t === 'calendar') {
            const div = document.getElementById('list-calendar');
            const highlightDiv = document.getElementById('calendar-highlight');
            const othersDiv = document.getElementById('calendar-others');
            
            const events = db.events;
            const highlight = events.find(e => e.status === 'OPEN') || events[events.length-1];
            
            const createCard = (e, isHighlight) => {
                const btnPoster = e.img ? `<img src="${e.img}" class="${isHighlight ? 'event-poster-full' : 'card-poster-thumb'}" onclick="verCartaz('${e.id}')">` : '';
                const valShow = e.val ? `<div class="event-price">R$ ${e.val}</div>` : '';
                
                let isClosed = e.status === 'CLOSED';
                if(e.closeDate && new Date().toISOString().split('T')[0] > e.closeDate) isClosed = true;

                // 1. DATA ENCERRAMENTO VISIVEL
                let closeDateDisplay = '';
                if(e.closeDate) {
                    const parts = e.closeDate.split('-');
                    closeDateDisplay = `<div class="event-close-date">ENCERRA EM: ${parts[2]}/${parts[1]}/${parts[0]}</div>`;
                }

                let actionBtn = isClosed 
                    ? `<button class="btn-closed">INSCRIÇÕES ENCERRADAS</button>` 
                    : `<button class="btn-insc" onclick="iniciarInscricao('${e.id}','${e.t}', '${e.val}')">INSCREVER</button>`;
                
                const btnPoints = `<button class="btn-points" onclick="showPublicPoints(${e.id})">TABELA DE PONTOS</button>`;

                if(loggedUser) {
                    const ins = loggedUser.inscricoes.find(i => i.id == e.id);
                    if(ins && ins.status === 'CONFIRMADO') { actionBtn = `<button class="btn-share" onclick="openShareModal('${e.t}')"><i class="fab fa-instagram"></i> TICKET</button>`; } 
                    else if(ins) { actionBtn = `<button class="btn-insc" style="background:orange">PENDENTE</button>`; }
                    else if(isClosed) { actionBtn = `<button class="btn-closed">ENCERRADO</button>`; }
                }
                
                const cardClass = isHighlight ? 'highlight-event' : 'event-card';
                return `<div class="${cardClass} ${e.status==='CLOSED'?'closed':''}">
                            ${isHighlight ? '' : `<div class="event-top"><span class="event-date">${e.d} ${e.m}</span></div>`}
                            ${isHighlight ? btnPoster : ''}
                            <div class="event-body">
                                ${isHighlight ? `<h2 style="color:#0038a8; margin:0">${e.t}</h2><p>${e.d} ${e.m} - ${e.city}</p>` : `<div class="event-title">${e.t}</div>`}
                                ${!isHighlight ? btnPoster : ''}
                                ${valShow}
                                ${!isHighlight ? `<div class="event-city"><i class="fas fa-map-marker-alt"></i> ${e.city}</div>` : ''}
                                ${closeDateDisplay}
                                <div class="badge-box">${e.est?'<span class="badge-pe">PE</span>':''}${e.cbc?'<span class="badge-cbc">CBC</span>':''}</div>
                                ${btnPoints}
                                ${actionBtn}
                            </div>
                        </div>`;
            };

            if(highlight) {
                highlightDiv.innerHTML = createCard(highlight, true);
                othersDiv.innerHTML = events.filter(e => e.id !== highlight.id).map(e => createCard(e, false)).join('');
            } else {
                highlightDiv.innerHTML = '';
                othersDiv.innerHTML = events.map(e => createCard(e, false)).join('');
            }

        } else if (t === 'tempos' || t === 'ranking') {
            const list = db[t].filter(i => i.status === 'OK'); 
            const div = document.getElementById('list-'+t);
            const selCat = document.getElementById('filter-cat-'+t);
            const selEvt = document.getElementById('filter-evt-'+t);
            if(selCat.innerHTML === '') { const cats = [...new Set(list.map(i => i.cat))]; selCat.innerHTML = `<option value="ALL">TODAS CATEGORIAS</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join(''); }
            if(selEvt.innerHTML === '' || (selEvt.options.length === 1 && t === 'tempos')) { const evts = db.events; let opts = t==='ranking' ? `<option value="ALL">GERAL (SOMA)</option>` : `<option value="ALL">TODAS ETAPAS</option>`; opts += evts.map(e => `<option value="${e.id}">${e.t}</option>`).join(''); selEvt.innerHTML = opts; }
            let filtered = list;
            if(selCat.value !== 'ALL') filtered = filtered.filter(i => i.cat === selCat.value);
            if(selEvt.value !== 'ALL') filtered = filtered.filter(i => i.evtId == selEvt.value);
            
            div.innerHTML = filtered.map((r, i) => {
                const evt = db.events.find(e => e.id == r.evtId);
                const cityDisplay = evt ? ` - ${evt.city}` : '';
                return `<div class="rank-row"><div class="rank-pos">${i+1}</div><div class="rank-name">${r.name}<span class="rank-cat">${r.cat}${cityDisplay}</span></div><div class="rank-val">${r.val}</div></div>`;
            }).join('');
        }
    }

    function openAdmSection(sec) {
        if(sec === 'events' && loggedUser.role !== 'ADMIN') { toast("APENAS ADMIN"); return backToAdmMenu(); }

        currentAdmSection = sec;
        localStorage.setItem(LAST_ADM_KEY, sec); 
        
        document.getElementById('adm-menu').style.display = 'none';
        if(sec === 'events') { 
            document.getElementById('adm-sec-events').style.display='block'; 
            refreshAdmLists(); 
            // 4. RESET FORM EVENT
            document.getElementById('adm-evt-id-edit').value = '';
            document.getElementById('btn-save-event').innerText = "CADASTRAR EVENTO";
            document.getElementById('evt-points-grid').innerHTML = Array(20).fill(0).map((_, i) => `<input type="number" placeholder="${i+1}º" id="pt-${i}" style="text-align:center; font-size:10px; padding:4px;">`).join('');
        }
        if(sec === 'results') { 
            document.getElementById('adm-sec-results').style.display='block'; refreshAdmLists(); 
            const selEvt = document.getElementById('adm-res-evt'); selEvt.innerHTML = '<option value="">SELECIONE EVENTO...</option>' + db.events.map(e => `<option value="${e.id}">${e.t}</option>`).join('');
            restoreAdmState(); 
        }
        if(sec === 'organizer') {
            document.getElementById('adm-sec-organizer').style.display='block';
            document.getElementById('org-events-list').innerHTML = db.events.map(e => `<label class="perm-item"><input type="checkbox" value="${e.id}" class="perm-cb"> ${e.t}</label>`).join('');
            renderOrgList();
        }
        if(sec === 'users-edit') {
             document.getElementById('adm-sec-users-edit').style.display='block';
        }
        if(sec === 'config') {
             document.getElementById('adm-sec-config').style.display='block';
        }
        if(sec === 'financial') { 
            document.getElementById('adm-sec-financial').style.display='block'; 
            const sel = document.getElementById('fin-evt-select'); 
            let availableEvents = db.events;
            if(loggedUser.role === 'ORGANIZER' && loggedUser.allowedEvts) {
                availableEvents = db.events.filter(e => loggedUser.allowedEvts.includes(e.id.toString()));
            }
            sel.innerHTML = '<option value="">SELECIONE...</option><option value="ALL">GERAL (TODOS EVENTOS)</option>' + availableEvents.map(e => `<option value="${e.id}">${e.t}</option>`).join(''); 
        }
    }

    function saveAdmState() {
        const state = {
            evt: document.getElementById('adm-res-evt').value,
            type: document.getElementById('adm-res-type').value,
            id: document.getElementById('adm-res-id').value,
            text: document.getElementById('adm-res-id').options[0]?.text || '',
            num: document.getElementById('adm-res-num').value,
            val: document.getElementById('adm-res-val').value
        };
        localStorage.setItem(FORM_STATE_KEY, JSON.stringify(state));
    }

    function restoreAdmState() {
        const saved = JSON.parse(localStorage.getItem(FORM_STATE_KEY));
        if(saved) {
            if(saved.evt) document.getElementById('adm-res-evt').value = saved.evt;
            if(saved.type) document.getElementById('adm-res-type').value = saved.type;
            if(saved.id) {
                const sel = document.getElementById('adm-res-id');
                sel.innerHTML = `<option value="${saved.id}">${saved.text}</option>`;
                sel.value = saved.id;
            }
            if(saved.num) document.getElementById('adm-res-num').value = saved.num;
            if(saved.val) document.getElementById('adm-res-val').value = saved.val;
        }
    }

    function backToAdmMenu() {
        localStorage.removeItem(LAST_ADM_KEY);
        document.querySelectorAll('[id^="adm-sub-"]').forEach(e => e.style.display='none'); 
        document.getElementById('adm-sec-events').style.display='none'; document.getElementById('adm-sec-results').style.display='none';
        document.getElementById('adm-sec-organizer').style.display='none'; document.getElementById('adm-sec-financial').style.display='none';
        document.getElementById('adm-sec-users-edit').style.display='none'; 
        document.getElementById('adm-menu').style.display='grid';
    }

    function checkAdmPass() { if(document.getElementById('adm-pass-check').value === ADMIN_PASS) { document.getElementById('adm-login-box').style.display='none'; document.getElementById('adm-panel-real').style.display='block'; backToAdmMenu(); } else { toast("SENHA INVÁLIDA"); } }
    
    function filterPilots(ctx, forceShow) {
        const inputId = ctx === 'res' ? 'adm-res-search' : (ctx === 'org' ? 'adm-org-search' : 'adm-edit-user-search');
        const listId = ctx === 'res' ? 'adm-res-list' : (ctx === 'org' ? 'adm-org-list-search' : 'adm-edit-user-list');
        const text = document.getElementById(inputId).value.toUpperCase();
        const listDiv = document.getElementById(listId);
        
        let currentEvtId = null;
        if(ctx === 'res') {
            currentEvtId = document.getElementById('adm-res-evt').value;
            if(!currentEvtId) { listDiv.style.display = 'none'; return; } 
        }

        listDiv.innerHTML = '';
        if(!forceShow && text.length < 2) { if(ctx!=='edit-user') listDiv.style.display = 'none'; return; }
        
        const filtered = db.users.filter(u => {
            const matchesText = (u.nome.includes(text) || u.cpf.includes(text) || u.city.includes(text));
            if(!matchesText) return false;
            if(ctx === 'res') {
                const insc = u.inscricoes.find(i => i.id == currentEvtId);
                return insc && insc.status === 'CONFIRMADO';
            }
            return true;
        });
        
        if(filtered.length === 0) { listDiv.style.display='none'; return; }
        
        listDiv.style.display = 'block';
        listDiv.innerHTML = filtered.map(u => {
            const wppUrl = `https://wa.me/55${u.tel ? u.tel.replace(/\D/g,'') : ''}`;
            const actions = ctx === 'edit-user' ? `<div class="smart-actions"><button class="btn-mini-adm btn-green" onclick="window.open('${wppUrl}')"><i class="fab fa-whatsapp"></i></button><button class="btn-mini-adm btn-blue" onclick="openEditUserModal('${u.cpf}')"><i class="fas fa-pen"></i></button></div>` : '';
            return `<div class="smart-item" onclick="${ctx!=='edit-user' ? `selectPilot('${u.cpf}', '${u.nome}', '${ctx}')` : ''}"><div><b>${u.nome}</b><br><span style="color:#666">${u.cat} | ${u.cpf}</span></div>${actions}</div>`;
        }).join('');
    }

    function selectPilot(cpf, name, ctx) {
        if(ctx === 'res') { 
            const sel = document.getElementById('adm-res-id');
            sel.innerHTML = `<option value="${cpf}">${name}</option>`;
            sel.value = cpf;
            document.getElementById('adm-res-search').value = '';
            document.getElementById('adm-res-list').style.display = 'none'; 
            saveAdmState();
        } 
        else if(ctx === 'org') { 
            document.getElementById('adm-org-selected-cpf').value = cpf; 
            document.getElementById('adm-org-search').value = name; 
            document.getElementById('adm-org-list-search').style.display = 'none'; 
        } 
    }

    function openEditUserModal(cpf) {
        const u = db.users.find(x => x.cpf === cpf);
        if(u) {
            document.getElementById('edit-user-original-cpf').value = u.cpf;
            document.getElementById('edit-user-name').value = u.nome;
            document.getElementById('edit-user-city').value = u.city;
            document.getElementById('edit-user-cat').value = u.cat;
            document.getElementById('edit-user-gender').value = u.gender || 'M';
            document.getElementById('modal-edit-user').style.display = 'flex';
        }
    }

    function saveUserEdit() {
        const cpf = document.getElementById('edit-user-original-cpf').value;
        const idx = db.users.findIndex(x => x.cpf === cpf);
        if(idx > -1) {
            db.users[idx].nome = document.getElementById('edit-user-name').value.toUpperCase();
            db.users[idx].city = document.getElementById('edit-user-city').value.toUpperCase();
            db.users[idx].cat = document.getElementById('edit-user-cat').value.toUpperCase();
            db.users[idx].gender = document.getElementById('edit-user-gender').value.toUpperCase();
            saveDB(); toast("DADOS ATUALIZADOS"); fecharModal('modal-edit-user');
            filterPilots('edit-user', true);
        }
    }

    function promoteToOrganizer() {
        const cpf = document.getElementById('adm-org-selected-cpf').value;
        if(!cpf) return toast("SELECIONE UM ATLETA");
        const perms = []; document.querySelectorAll('.perm-cb:checked').forEach(cb => perms.push(cb.value));
        const idx = db.users.findIndex(u => u.cpf === cpf);
        if(idx > -1) { db.users[idx].role = 'ORGANIZER'; db.users[idx].allowedEvts = perms; db.users[idx].cat = "ORGANIZAÇÃO"; saveDB(); toast("PROMOVIDO!"); document.getElementById('adm-org-search').value = ''; renderOrgList(); }
    }

    function demoteOrganizer(cpf) {
        if(confirm("REMOVER PERMISSÃO DE ORGANIZADOR?")) {
            const idx = db.users.findIndex(u => u.cpf === cpf);
            if(idx > -1) { db.users[idx].role = 'USER'; db.users[idx].cat = "RÍGIDA"; db.users[idx].allowedEvts = []; saveDB(); renderOrgList(); }
        }
    }

    function renderOrgList() { document.getElementById('adm-list-orgs').innerHTML = db.users.filter(u => u.role === 'ORGANIZER').map(o => `<div class="admin-item-row"><span>${o.nome}</span><div class="admin-actions"><button class="btn-mini-adm btn-red" onclick="demoteOrganizer('${o.cpf}')"><i class="fas fa-trash"></i></button></div></div>`).join(''); }
    
    let currentFilterStatus = 'ALL';
    function filterFinList(status) { currentFilterStatus = status; renderInscriptions(); }

    function renderInscriptions() {
        const evtId = document.getElementById('fin-evt-select').value; const div = document.getElementById('fin-list-container');
        if(!evtId) return div.innerHTML = '';
        
        let totalCount = 0; let paidCount = 0; let totalMoney = 0;
        let html = '<table class="fin-table"><thead><tr><th>NOME</th><th>STATUS</th><th>AÇÃO</th></tr></thead><tbody>';
        
        if(evtId === 'ALL') {
             db.users.forEach(u => {
                u.inscricoes.forEach(ins => {
                    totalCount++;
                    if(ins.status === 'CONFIRMADO') { 
                        paidCount++; 
                        const evt = db.events.find(e => e.id == ins.id);
                        if(evt) totalMoney += parseFloat(evt.val.replace(',','.'));
                    }
                    if(currentFilterStatus !== 'ALL' && ins.status !== currentFilterStatus) return;
                    
                    const evtName = db.events.find(e => e.id == ins.id)?.t || '???';
                    const statusClass = ins.status === 'CONFIRMADO' ? 'status-ok' : 'status-pend';
                    html += `<tr><td><b>${u.nome}</b><br><span style="color:#666;font-size:9px">${evtName}</span></td><td><span class="${statusClass}" onclick="toggleStatus('${u.cpf}','${ins.id}')">${ins.status}</span></td><td></td></tr>`;
                });
             });
        } else {
            db.users.forEach(u => {
                const insc = u.inscricoes.find(i => i.id == evtId);
                if(insc) {
                    totalCount++;
                    if(insc.status === 'CONFIRMADO') { paidCount++; }
                    if(currentFilterStatus !== 'ALL' && insc.status !== currentFilterStatus) return;

                    const wppUrl = `https://wa.me/55${u.tel ? u.tel.replace(/\D/g,'') : ''}`;
                    const statusClass = insc.status === 'CONFIRMADO' ? 'status-ok' : 'status-pend';
                    
                    html += `<tr><td>${u.nome} <a href="${wppUrl}" target="_blank" style="text-decoration:none;" class="wpp-big"><i class="fab fa-whatsapp"></i></a><br><span style="color:#666;font-size:9px">${u.cat}</span></td><td><span class="${statusClass}" onclick="toggleStatus('${u.cpf}','${evtId}')">${insc.status}</span></td><td></td></tr>`;
                }
            });
            const evt = db.events.find(e => e.id == evtId);
            if(evt) totalMoney = paidCount * parseFloat(evt.val.replace(',','.'));
        }

        document.getElementById('stat-total').innerText = `Total: ${totalCount}`;
        document.getElementById('stat-paid').innerText = `Pagos: ${paidCount}`;
        document.getElementById('stat-money').innerText = `R$ ${totalMoney.toFixed(2)}`;

        div.innerHTML = html + '</tbody></table>';
    }

    function toggleStatus(cpf, evtId) { 
        const u = db.users.find(x => x.cpf === cpf); 
        const ins = u.inscricoes.find(i => i.id == evtId); 
        if(ins.status === 'CONFIRMADO') { ins.status = 'PENDENTE'; ins.confirmedBy = null; } 
        else { ins.status = 'CONFIRMADO'; ins.confirmedBy = loggedUser.nome.split(' ')[0]; }
        saveDB(); renderInscriptions(); 
    }

    // --- PRINT REPORT ---
    function openPrintOptions() {
        const evtId = document.getElementById('fin-evt-select').value;
        if(!evtId || evtId === 'ALL') return toast("SELECIONE UM EVENTO ESPECÍFICO");
        let cats = new Set();
        db.users.forEach(u => { if(u.inscricoes.some(i => i.id == evtId)) cats.add(u.cat); });
        document.getElementById('print-cat-list').innerHTML = Array.from(cats).map(c => `<button class="btn-mini-adm" style="text-align:left; padding:8px; width:100%" onclick="generatePrint('${c}')">${c}</button>`).join('');
        document.getElementById('modal-print-options').style.display = 'flex';
    }

    function generatePrint(categoryFilter) {
        const evtId = document.getElementById('fin-evt-select').value;
        const evt = db.events.find(e => e.id == evtId);
        let usersIn = [];
        db.users.forEach(u => { const insc = u.inscricoes.find(i => i.id == evtId); if(insc && (categoryFilter === 'ALL' || u.cat === categoryFilter)) usersIn.push({ ...u, status: insc.status }); });
        const grouped = {};
        usersIn.forEach(u => { if(!grouped[u.cat]) grouped[u.cat] = []; grouped[u.cat].push(u); });

        let html = `<div class="print-header"><h1>${evt.t}</h1><p>PLANILHA DE CRONOMETRAGEM - ${categoryFilter === 'ALL' ? 'GERAL' : categoryFilter}</p></div>`;
        for (const cat in grouped) {
            html += `<div class="print-cat-block"><div class="print-cat-title">${cat}</div>
            <table class="print-table"><thead><tr><th>NOME</th><th>CIDADE</th><th>CATEGORIA</th><th class="manual-cell">Nº</th><th class="manual-cell">TEMPO</th></tr></thead><tbody>`;
            grouped[cat].forEach(u => { html += `<tr><td>${u.nome}</td><td>${u.city}</td><td>${u.cat}</td><td></td><td></td></tr>`; });
            html += `</tbody></table></div>`;
        }
        document.getElementById('printable-area').innerHTML = html;
        fecharModal('modal-print-options');
        window.print();
    }
    
    function openShareModal(evtName) {
        document.getElementById('share-piloto-name').innerText = loggedUser.nome;
        document.getElementById('share-event-name').innerText = evtName;
        document.getElementById('modal-share').style.display = 'flex';
    }
    function shareNative() {
        if (navigator.share) {
            navigator.share({ title: 'Eu Vou! DH-PE', text: `Confirmei minha presença no ${document.getElementById('share-event-name').innerText}!`, url: window.location.href }).catch(console.error);
        } else { alert("Tire um print da tela para compartilhar!"); }
    }

    // 4. RANKING AUTOMATICO
    function recalcRankingFromTimes(evtId) {
        db.ranking = db.ranking.filter(r => r.evtId != evtId);
        const times = db.tempos.filter(t => t.evtId == evtId && t.status === 'OK');
        const grouped = {};
        times.forEach(t => { if(!grouped[t.cat]) grouped[t.cat] = []; grouped[t.cat].push(t); });
        
        const evt = db.events.find(e => e.id == evtId);
        const ptsRule = evt.points || [50,45,40,35,30,26,24,22,20,18,16,14,12,10,8,6,4,3,2,1];

        for(let cat in grouped) {
            grouped[cat].sort((a,b) => a.val.localeCompare(b.val));
            grouped[cat].forEach((t, index) => {
                if(index < 20) {
                    const pts = ptsRule[index] || 0;
                    if(pts > 0) {
                        db.ranking.push({ name: t.name, val: pts + ' PTS', cat: cat, city: t.city, evtId: evtId, status: 'OK' });
                    }
                }
            });
        }
        saveDB();
    }

    // 5. MODAL PUBLICO PONTOS
    function showPublicPoints(evtId) {
        const evt = db.events.find(e => e.id == evtId);
        const pts = evt.points || [50,45,40,35,30,26,24,22,20,18,16,14,12,10,8,6,4,3,2,1];
        document.getElementById('modal-points-subtitle').innerText = evt.t;
        document.getElementById('public-points-list').innerHTML = pts.map((p, i) => `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px;"><b>${i+1}º LUGAR</b> <span>${p} PTS</span></div>`).join('');
        document.getElementById('modal-points').style.display = 'flex';
    }

    function gerarTermo(evtId) {
        const evt = db.events.find(e => e.id == evtId);
        const user = loggedUser;
        const isMinor = user.cat.includes("INFANTO") || user.cat.includes("JUVENIL") || user.cat.includes("JUNIOR"); 
        
        const content = `
            <div class="termo-container">
                <div class="termo-title">TERMO DE RESPONSABILIDADE</div>
                <div class="termo-body">
                    Eu, <b>${user.nome}</b>, inscrito no CPF nº <b>${user.cpf}</b>, na categoria <b>${user.cat}</b>, declaro para os devidos fins que:
                    <br><br>
                    1. Estou apto fisicamente e mentalmente para participar do evento <b>${evt.t}</b> em <b>${evt.city}</b>.<br>
                    2. Assumo total responsabilidade por qualquer acidente, lesão ou dano material que venha a sofrer ou causar a terceiros.<br>
                    3. Isento a organização, patrocinadores e a Federação de qualquer responsabilidade civil ou criminal.<br>
                    4. Uso obrigatório de equipamentos de segurança (Capacete Integral, etc).
                </div>
                <div class="termo-sign">Assinatura do Atleta</div>
                ${isMinor ? `<div class="termo-body" style="margin-top:30px"><b>AUTORIZAÇÃO PARA MENOR DE IDADE</b><br>Eu, responsável legal pelo atleta acima, autorizo sua participação e assumo todas as responsabilidades citadas.</div><div class="termo-field">Nome do Responsável: __________________________________________________</div><div class="termo-field">CPF do Responsável: __________________________________________________</div><div class="termo-sign">Assinatura do Responsável</div>` : ''}
                <div class="termo-obs">Data: ____/____/2026 - Entregar assinado na retirada do numeral.</div>
            </div>
        `;
        document.getElementById('printable-area').innerHTML = content;
        fecharModal('modal-ticket');
        window.print();
    }

    function refreshAdmLists() { 
        document.getElementById('adm-list-events').innerHTML = db.events.map((e, i) => `<div class="admin-item-row"><span>${e.t}</span><div class="admin-actions"><button class="btn-mini-adm btn-blue" onclick="editEvent(${e.id})"><i class="fas fa-pen"></i></button><button class="btn-mini-adm btn-red" onclick="delItem('events', ${i})"><i class="fas fa-trash"></i></button></div></div>`).join(''); 
        document.getElementById('adm-list-results').innerHTML = db.tempos.map((t, i) => { 
            const approveBtn = (t.status === 'PENDING' && loggedUser.role === 'ADMIN') ? `<button class="btn-mini-adm btn-green" onclick="approveResult('tempos', ${i})">✅</button>` : ''; 
            const statusTag = t.status === 'PENDING' ? '<span class="pending-tag">PENDENTE</span>' : ''; 
            const numDisplay = t.num ? `<b>#${t.num}</b> - ` : '';
            return `<div class="admin-item-row ${t.status==='PENDING'?'pending-row':''}"><span>${numDisplay}${t.name} - ${t.val}${statusTag}</span><div class="admin-actions">${approveBtn}<button class="btn-mini-adm btn-blue" onclick="editResult('tempos', ${i})"><i class="fas fa-pen"></i></button><button class="btn-mini-adm btn-red" onclick="delItem('tempos', ${i})"><i class="fas fa-trash"></i></button></div></div>`; 
        }).join(''); 
    }

    function editEvent(id) { 
        const evt = db.events.find(e => e.id == id); 
        if(evt) { 
            document.getElementById('adm-evt-id-edit').value = evt.id; 
            document.getElementById('adm-evt-t').value = evt.t; 
            document.getElementById('adm-evt-month').value = evt.m; 
            document.getElementById('adm-evt-d').value = evt.d; 
            document.getElementById('adm-evt-c').value = evt.city; 
            document.getElementById('adm-evt-v').value = evt.val || ''; 
            document.getElementById('adm-evt-close-date').value = evt.closeDate || '';
            document.getElementById('adm-evt-status').value = evt.status || 'OPEN';
            const pts = evt.points || [50,45,40,35,30,26,24,22,20,18,16,14,12,10,8,6,4,3,2,1];
            document.getElementById('evt-points-grid').innerHTML = pts.map((p, i) => `<input type="number" placeholder="${i+1}º" value="${p}" id="pt-${i}" style="text-align:center; font-size:10px; padding:4px;">`).join('');
            document.getElementById('btn-save-event').innerText = "ATUALIZAR"; 
        } 
    }

    // 2. CORRECAO ERRO LINHA 533 (REFACTORED ADD EVENT)
    function addEvent() { 
        const idEdit = document.getElementById('adm-evt-id-edit').value; 
        const t = document.getElementById('adm-evt-t').value.toUpperCase(); 
        const m = document.getElementById('adm-evt-month').value; 
        const d = document.getElementById('adm-evt-d').value; 
        const c = document.getElementById('adm-evt-c').value.toUpperCase(); 
        const v = document.getElementById('adm-evt-v').value; 
        const closeDate = document.getElementById('adm-evt-close-date').value;
        const status = document.getElementById('adm-evt-status').value;
        const imgInput = document.getElementById('adm-evt-img'); 
        
        const newPoints = [];
        for(let i=0; i<20; i++) {
            const el = document.getElementById(`pt-${i}`);
            newPoints.push(el && el.value ? parseInt(el.value) : 0);
        }

        const finalizeSave = (imgData) => {
             if(t && d && c) { 
                if(idEdit) { 
                    const idx = db.events.findIndex(e => e.id == idEdit); 
                    if(idx > -1) { 
                        db.events[idx] = { ...db.events[idx], t, m, d, city:c, val:v, points: newPoints, status: status, closeDate: closeDate }; 
                        if(imgData) db.events[idx].img = imgData; 
                        toast("ATUALIZADO"); 
                    } 
                } else { 
                    const newEvt = {id:Date.now(), t, d, m, city:c, val:v, est:document.getElementById('adm-evt-cb-pe').checked, cbc:document.getElementById('adm-evt-cb-cbc').checked, open:true, img: imgData, points: newPoints, status: status, closeDate: closeDate};
                    db.events.push(newEvt); 
                    toast("CRIADO"); 
                } 
                saveDB(); refreshAdmLists(); 
                // 4. RESET FORM
                document.getElementById('adm-evt-t').value=''; 
                document.getElementById('adm-evt-d').value=''; 
                document.getElementById('adm-evt-c').value=''; 
                document.getElementById('adm-evt-v').value=''; 
                document.getElementById('adm-evt-id-edit').value=''; 
                document.getElementById('adm-evt-close-date').value='';
                document.getElementById('btn-save-event').innerText='CADASTRAR EVENTO'; 
            } else {
                toast("PREENCHA OS CAMPOS");
            }
        };

        if(imgInput.files[0]) { 
            compressImage(imgInput.files[0], 800, (compressed) => finalizeSave(compressed)); 
        } else { 
            finalizeSave(null); 
        } 
    }

    function editResult(type, index) { const res = db[type][index]; if(res) { document.getElementById('adm-res-index-edit').value = index; document.getElementById('adm-res-type-edit').value = type; document.getElementById('adm-res-type').value = type; document.getElementById('adm-res-evt').value = res.evtId; const u = db.users.find(u => u.nome === res.name); if(u) { document.getElementById('adm-res-id').innerHTML = `<option value="${u.cpf}">${u.nome}</option>`; document.getElementById('adm-res-id').value = u.cpf; document.getElementById('adm-res-search').value = u.nome; } document.getElementById('adm-res-val').value = res.val; document.getElementById('adm-res-num').value = res.num || ''; document.getElementById('btn-save-res').innerText = "ATUALIZAR"; document.getElementById('btn-cancel-res').style.display = 'block'; } }
    function cancelEditRes() { document.getElementById('adm-res-index-edit').value=''; document.getElementById('adm-res-val').value=''; document.getElementById('adm-res-num').value=''; document.getElementById('adm-res-search').value=''; document.getElementById('btn-save-res').innerText='LANÇAR'; document.getElementById('btn-cancel-res').style.display='none'; }
    
    function addResult() { 
        const idx = document.getElementById('adm-res-index-edit').value; 
        const type = document.getElementById('adm-res-type').value; 
        const evtId = document.getElementById('adm-res-evt').value; 
        const cpf = document.getElementById('adm-res-id').value; 
        const val = document.getElementById('adm-res-val').value; 
        const num = document.getElementById('adm-res-num').value; 
        
        if(!evtId || !cpf || !val) return toast("PREENCHA TUDO"); 
        
        const piloto = db.users.find(u => u.cpf === cpf); 
        
        if(!idx && db[type].some(x => x.evtId == evtId && x.name == piloto.nome)) {
            return toast("PILOTO JÁ LANÇADO NESTE EVENTO!");
        }

        const newData = { name: piloto.nome, val: val, num: num, cat: piloto.cat.split('(')[0].trim(), city: piloto.city || 'PE', evtId: evtId, status: loggedUser.role === 'ADMIN' ? 'OK' : 'PENDING' }; 
        
        if(idx) { 
            const oldType = document.getElementById('adm-res-type-edit').value; 
            db[oldType][idx] = newData; 
            toast("ATUALIZADO"); 
        } else { 
            db[type].push(newData); 
            toast("LANÇADO"); 
        } 
        
        if(type === 'tempos') {
             db[type].sort((a,b) => a.val.localeCompare(b.val)); 
             if(loggedUser.role === 'ADMIN') recalcRankingFromTimes(evtId);
        } else {
             db[type].sort((a,b) => parseInt(b.val) - parseInt(a.val));
        }

        document.getElementById('adm-res-val').value=''; 
        document.getElementById('adm-res-num').value=''; 
        document.getElementById('adm-res-search').value=''; 
        document.getElementById('adm-res-id').innerHTML = '<option value="">⬇ BUSQUE ABAIXO ⬇</option>';
        document.getElementById('adm-res-id').value = '';
        
        saveDB(); 
        refreshAdmLists(); 
        cancelEditRes(); 
    }

    function approveResult(type, index) { 
        db[type][index].status = 'OK'; 
        if(type === 'tempos') recalcRankingFromTimes(db[type][index].evtId);
        saveDB(); 
        refreshAdmLists(); 
        toast("APROVADO!"); 
    }

    function iniciarInscricao(evtId, evtName, val) { if(!loggedUser) return toast("FAÇA LOGIN PRIMEIRO"); if(loggedUser.inscricoes.some(i => i.id == evtId)) return toast("JÁ INSCRITO"); currentPayId = { id: parseInt(evtId), name: evtName }; document.getElementById('pix-valor-display').innerText = val ? `R$ ${val}` : "R$ 100,00"; document.getElementById('pix-copy').innerText = "00020126360014BR.GOV.BCB.PIX0114+55819000000005204000053039865802BR5925FPC FEDERACAO PE CICLISMO6006RECIFE62070503***6304E2CA"; document.getElementById('modal-pix').style.display='flex'; }
    function enviarComprovanteWhatsApp() { window.open(`https://wa.me/?text=Olá, segue comprovante de inscrição para: ${currentPayId.name} - Piloto: ${loggedUser.nome}`, '_blank'); }
    function confirmarJaPaguei() { if(!loggedUser.inscricoes.some(i => i.id == currentPayId.id)) { loggedUser.inscricoes.push({ id: currentPayId.id, status: 'PENDENTE' }); const idx = db.users.findIndex(x => x.cpf === loggedUser.cpf); if(idx > -1) db.users[idx].inscricoes = loggedUser.inscricoes; saveDB(); localStorage.setItem(SESS_KEY, JSON.stringify(loggedUser)); } fecharModal('modal-pix'); toast("REGISTRADO!"); renderContent('calendar'); }
    function verCartaz(id) { const evt = db.events.find(e => e.id == id); if(evt && evt.img) { document.getElementById('img-poster-view').src = evt.img; document.getElementById('modal-poster').style.display = 'flex'; } }
    function fecharModal(id){ document.getElementById(id).style.display='none'; }
    function delItem(col, idx) { 
        if(confirm("APAGAR?")) { 
            const item = db[col][idx];
            db[col].splice(idx, 1); 
            if(col === 'tempos') recalcRankingFromTimes(item.evtId); 
            saveDB(); 
            refreshAdmLists(); 
        } 
    }
    
    function maskTimeOrPoints(i, e) { 
        if(document.getElementById('adm-res-type').value === 'ranking') return; 
        if(e && e.inputType === 'deleteContentBackward') return; 
        let v = i.value.replace(/\D/g, ""); 
        if (v.length > 7) v = v.substring(0, 7); 
        if (v.length > 5) v = v.substring(0, 5) + "." + v.substring(5); 
        if (v.length > 2) v = v.substring(0, 2) + ":" + v.substring(2); 
        i.value = v; 
    }
    
    function copiarPix() { navigator.clipboard.writeText(document.getElementById('pix-copy').innerText); toast("PIX COPIADO!"); }
    function imprimirTicket() { document.body.classList.add('printing-cupom'); setTimeout(() => { window.print(); setTimeout(() => document.body.classList.remove('printing-cupom'), 1000); }, 500); }

    function fazerLogin() { 
        try {
            const cpfRaw = document.getElementById('login-cpf').value; const pass = document.getElementById('login-pass').value; const remember = document.getElementById('login-remember').checked;
            if(!cpfRaw || !pass) return toast("PREENCHA TUDO");
            const user = db.users.find(x => cleanCPF(x.cpf) === cleanCPF(cpfRaw) && x.pass === pass);
            if(user) { 
                loggedUser = user; localStorage.setItem(SESS_KEY, JSON.stringify(user)); 
                if(remember) localStorage.setItem(REMEMBER_KEY, cpfRaw + "|" + pass); 
                initApp(); 
            } else { toast("DADOS INCORRETOS"); }
        } catch(e) { console.log(e); }
    }
    
    function fazerLogout() { localStorage.removeItem(SESS_KEY); window.location.reload(true); }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    function cadastrar() { 
        const u = { 
            nome: document.getElementById('cad-nome').value.toUpperCase(), 
            cpf: document.getElementById('cad-cpf').value, 
            tel: document.getElementById('cad-tel').value, 
            city: document.getElementById('cad-city').value.toUpperCase(), 
            pass: document.getElementById('cad-pass').value, 
            cat: document.getElementById('cad-cat').value, 
            gender: document.getElementById('cad-gender').value, 
            role: 'USER', 
            inscricoes: [] 
        };
        
        const fileInput = document.getElementById('cad-selfie');
        if(!u.nome || !u.cpf || !u.pass) return toast("PREENCHA TUDO");
        if(fileInput.files.length === 0) return toast("SELFIE OBRIGATÓRIA");

        if(db.users.some(x => cleanCPF(x.cpf) === cleanCPF(u.cpf))) return toast("CPF JÁ EXISTE");
        
        compressImage(fileInput.files[0], 300, (base64) => {
             u.selfie = base64;
             db.users.push(u); 
             saveDB(); 
             toast("SUCESSO!"); 
             trocarTela('login');
        });
    }
    
    function reCalcCat() { const gender = document.getElementById('cad-gender').value; const date = document.getElementById('cad-nasc').value; calcCat(date, gender); }
    function calcCat(dateStr, gender) { if(gender === 'F') { document.getElementById('cad-cat').value = "FEMININA"; return; } if(!dateStr) return; const age = 2026 - new Date(dateStr).getFullYear(); let cat = "RÍGIDA"; if (age >= 12 && age <= 14) cat = "INFANTO-JUVENIL"; else if (age >= 15 && age <= 16) cat = "JUVENIL"; else if (age >= 17 && age <= 18) cat = "JUNIOR"; else if (age >= 19 && age <= 29) cat = "SUB-30 / ELITE"; else if (age >= 30 && age <= 34) cat = "MASTER A1"; else if (age >= 35 && age <= 39) cat = "MASTER A2"; else if (age >= 40 && age <= 44) cat = "MASTER B1"; else if (age >= 45 && age <= 49) cat = "MASTER B2"; else if (age >= 50 && age <= 54) cat = "MASTER C1"; else if (age >= 55 && age <= 59) cat = "MASTER C2"; else if (age >= 60) cat = "MASTER D"; document.getElementById('cad-cat').value = cat + ` (${age} ANOS)`; }

    function initApp() { 
        if(db.config.logo) document.querySelectorAll('.app-logo-img').forEach(el => el.src = db.config.logo);
        trocarTela('app'); 
        
        const lastTab = localStorage.getItem('last_tab_v52');
        if(lastTab) {
            nav(lastTab);
        } else {
             if(loggedUser && (loggedUser.role === 'ADMIN' || loggedUser.role === 'ORGANIZER')) nav('adm'); else nav('calendar');
        }
    }

    document.getElementById('btn-acessar').addEventListener('click', fazerLogin);
    const savedCreds = localStorage.getItem(REMEMBER_KEY); const session = getUser();
    if(session) { loggedUser = db.users.find(u => cleanCPF(u.cpf) === cleanCPF(session.cpf)); if(loggedUser) initApp(); } 
    else if (savedCreds) { const p = savedCreds.split('|'); document.getElementById('login-cpf').value = p[0]; document.getElementById('login-pass').value = p[1]; document.getElementById('login-remember').checked = true; }
    if(db.config.logo) document.querySelectorAll('.app-logo-img').forEach(el => el.src = db.config.logo);
</script>
</body>
</html>
